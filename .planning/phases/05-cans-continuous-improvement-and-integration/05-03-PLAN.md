---
phase: 05-cans-continuous-improvement-and-integration
plan: 03
type: execute
wave: 3
depends_on:
  - 05-01
  - 05-02
files_modified:
  - test/integration/e2e-flow.test.ts
  - test/integration/security-review.test.ts
  - test/integration/refinement.test.ts
  - test/fixtures/synthetic-neurosurgeon.ts
autonomous: true
requirements:
  - INTG-01
  - INTG-02
  - INTG-03

must_haves:
  truths:
    - "End-to-end flow works: fresh workspace -> register -> activate -> hardening -> skills load -> audit chain intact"
    - "Security review validates all six hardening layers correctly block unauthorized actions"
    - "Adversarial scenarios are covered: scope violation, audit log tampering, skill file modification"
    - "A developer install path test validates the public API surface works from fresh workspace to clinical agent"
    - "Refinement engine integration test verifies observe -> detect -> propose -> resolve -> CANS.md update cycle"
    - "All integration tests use realistic synthetic neurosurgeon persona with specific credentials"
  artifacts:
    - path: "test/integration/e2e-flow.test.ts"
      provides: "End-to-end flow verification and developer install path"
      contains: "INTG-01"
    - path: "test/integration/security-review.test.ts"
      provides: "Security review exercising all six hardening layers plus adversarial scenarios"
      contains: "INTG-02"
    - path: "test/integration/refinement.test.ts"
      provides: "Refinement engine end-to-end integration test"
      contains: "refinement"
    - path: "test/fixtures/synthetic-neurosurgeon.ts"
      provides: "Realistic neurosurgeon persona fixture for integration tests"
      exports: ["syntheticNeurosurgeonCANS", "syntheticNeurosurgeonCANSContent"]
  key_links:
    - from: "test/integration/e2e-flow.test.ts"
      to: "src/entry/openclaw.ts"
      via: "register(mockAPI) simulates full plugin lifecycle"
      pattern: "register\\(.*api"
    - from: "test/integration/security-review.test.ts"
      to: "src/hardening/engine.ts"
      via: "createHardeningEngine().check() exercised per layer"
      pattern: "engine\\.check|createHardeningEngine"
    - from: "test/integration/refinement.test.ts"
      to: "src/refinement/refinement-engine.ts"
      via: "Full observe -> propose -> resolve cycle with real files"
      pattern: "createRefinementEngine.*observe.*resolveProposal"
---

<objective>
Create comprehensive integration tests verifying the complete end-to-end flow, security hardening review, developer install path, and refinement engine lifecycle.

Purpose: This plan validates that the entire system built across Phases 1-5 works together correctly. The E2E flow test simulates a fresh install through clinical documentation generation. The security review exercises all six hardening layers with adversarial scenarios. The refinement integration test verifies the full observe-detect-propose-resolve cycle with real files. All tests use a realistic synthetic neurosurgeon persona.

Output: Three integration test files and a shared synthetic neurosurgeon fixture.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cans-continuous-improvement-and-integration/05-RESEARCH.md
@.planning/phases/05-cans-continuous-improvement-and-integration/05-01-SUMMARY.md
@.planning/phases/05-cans-continuous-improvement-and-integration/05-02-SUMMARY.md
@src/entry/openclaw.ts
@src/entry/standalone.ts
@src/hardening/engine.ts
@src/skills/loader.ts
@src/audit/pipeline.ts
@src/activation/cans-integrity.ts
@src/credentials/validator.ts
@test/fixtures/valid-cans-data.ts
@test/integration/plugin.test.ts
@test/integration/hardening.test.ts
@test/integration/skills.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create synthetic neurosurgeon fixture, E2E flow test, and developer install path test</name>
  <files>
    test/fixtures/synthetic-neurosurgeon.ts
    test/integration/e2e-flow.test.ts
    test/integration/refinement.test.ts
  </files>
  <action>
    Create `test/fixtures/synthetic-neurosurgeon.ts`:
    - Import `validCANSData` from `./valid-cans-data.ts`
    - Import `stringifyYAML` from `../../src/vendor/yaml/index.ts`
    - Export `syntheticNeurosurgeonCANS` — a complete CANS document extending validCANSData with realistic neurosurgeon data:
      ```typescript
      export const syntheticNeurosurgeonCANS = {
        ...validCANSData,
        provider: {
          ...validCANSData.provider,
          name: 'Dr. Sarah Chen',
          npi: '1234567890',
          license: { type: 'MD' as const, state: 'TX', number: 'TX-NS-2024-001', verified: false },
          specialty: 'Neurosurgery',
          subspecialty: 'Spine',
          institution: 'University Medical Center',
          privileges: ['neurosurgical procedures', 'spine surgery', 'craniotomy'],
          credential_status: 'active' as const,
        },
        clinical_voice: {
          tone: 'formal',
          documentation_style: 'structured',
          eponyms: true,
          abbreviations: 'standard medical',
        },
      };
      ```
    - Export `syntheticNeurosurgeonCANSContent` — the fully formatted CANS.md string with YAML frontmatter:
      ```typescript
      export const syntheticNeurosurgeonCANSContent = `---\n${stringifyYAML(syntheticNeurosurgeonCANS)}---\n\nDr. Sarah Chen is a board-eligible neurosurgeon specializing in spine surgery at University Medical Center.`;
      ```
    - Export helper `createTestWorkspace(dir: string): void` that:
      1. Writes `CANS.md` with `syntheticNeurosurgeonCANSContent`
      2. Creates `.careagent/` directory
      3. Calls `updateKnownGoodHash(dir, syntheticNeurosurgeonCANSContent)` to seed integrity

    Create `test/integration/e2e-flow.test.ts`:

    **Test group: INTG-01 — End-to-End Flow**
    Follow the established integration test pattern from `test/integration/plugin.test.ts` — use `mkdtempSync` temp workspaces with real file I/O.

    Create a mock API factory (same pattern as existing tests):
    - `createMockAPI(workspacePath)` returns an object with:
      - `getWorkspacePath()` returning the workspace path
      - `registerCliCommand(config)` storing commands in a dictionary
      - `registerBackgroundService(config)` storing the service
      - `on(event, handler)` storing event handlers in a dictionary
      - `log(level, msg)` storing log messages
      - `registerSlashCommand(config)` no-op
      - `registerService(config)` no-op
      - Accessor methods to retrieve stored handlers for test assertions

    Tests:
    1. `it('completes fresh workspace -> register -> activate -> skills -> audit')`:
       - Create temp workspace with `createTestWorkspace(dir)`
       - Create a `skills/chart-skill/` directory with a minimal `skill-manifest.json` matching chart-skill requirements (correct requires for neurosurgeon credentials)
       - Create mock API
       - Import and call `register(api)` from `src/entry/openclaw.ts`
       - Assert: activation log entry in AUDIT.log has `outcome: 'active'`
       - Assert: hardening-related handlers were registered (on('before_tool_call'), on('agent:bootstrap'))
       - Assert: skill loading occurred (check AUDIT.log for skill_load entries or log messages)
       - Assert: audit chain is intact — read AUDIT.log, verify hash chaining across all entries
       - Assert: refinement engine was created (careagent proposals command registered)

    2. `it('handles missing CANS.md gracefully (inactive mode)')`:
       - Create temp workspace WITHOUT CANS.md
       - Register plugin
       - Assert: activation log says `outcome: 'inactive'`
       - Assert: no hardening hooks registered
       - Assert: CLI commands still registered (careagent init available)

    3. `it('handles malformed CANS.md with clear error')`:
       - Create temp workspace with malformed CANS.md (missing required fields)
       - Register plugin
       - Assert: activation is inactive with a schema error reason

    4. `it('handles tampered CANS.md (integrity mismatch)')`:
       - Create temp workspace with valid CANS.md and seeded hash
       - Modify CANS.md content after hash is seeded
       - Register plugin
       - Assert: activation is inactive with integrity mismatch reason

    **Test group: INTG-03 — Developer Install Path**
    5. `it('standalone API: activate -> check engine -> inspect skills')`:
       - Create temp workspace with `createTestWorkspace(dir)`
       - Import and call `activate(dir)` from `src/entry/standalone.ts`
       - Assert: `result.activation.active === true`
       - Assert: `result.engine` exists (hardening engine)
       - Assert: `result.audit` is an AuditPipeline
       - Assert: `result.refinement` exists (refinement engine)
       - This verifies a developer using the standalone API can reach a functional clinical agent

    Create `test/integration/refinement.test.ts`:

    **Refinement Engine E2E Integration**
    1. `it('full cycle: observe -> detect -> propose -> accept -> CANS.md updated')`:
       - Create temp workspace with `createTestWorkspace(dir)`
       - Create `AuditPipeline(dir)`
       - Create refinement engine with `createRefinementEngine({ workspacePath: dir, audit, sessionId: 'test' })`
       - Record 6 observations of voice tone divergence: `field_path: 'clinical_voice.tone'`, `declared_value: 'formal'`, `observed_value: 'conversational'`
       - Call `engine.generateProposals()` — should produce 1 proposal
       - Assert: proposal has `field_path: 'clinical_voice.tone'`, `proposed_value: 'conversational'`
       - Assert: AUDIT.log has `cans_proposal_created` entry
       - Call `engine.resolveProposal(proposal.id, 'accept')`
       - Read CANS.md — verify `clinical_voice.tone` is now `'conversational'`
       - Verify integrity: `verifyIntegrity(dir, readFileSync(cansPath, 'utf-8'))` returns `valid: true`
       - Assert: AUDIT.log has `cans_proposal_accepted` entry

    2. `it('scope field observations never generate proposals')`:
       - Create temp workspace
       - Create refinement engine
       - Record 10+ observations with `field_path: 'scope.permitted_actions'`
       - Call `engine.generateProposals()` — should produce 0 proposals

    3. `it('rejected proposal resurfaces at higher threshold')`:
       - Record 5 voice observations, generate proposal, reject it
       - Record 5 more voice observations (total 10, but only 5 since rejection)
       - Call `generateProposals()` — may or may not resurface depending on implementation
       - Record 5 more (total 15 since last check), call again
       - Assert: resurfaced proposal eventually appears with updated evidence

    4. `it('deferred proposal persists and remains visible')`:
       - Generate proposal, defer it
       - Call `getPendingProposals()` — deferred proposal should be included
       - Create a NEW refinement engine instance (simulating session restart)
       - Call `getPendingProposals()` — deferred proposal is still there (persisted)
  </action>
  <verify>
    Run `npx vitest run test/integration/e2e-flow.test.ts` — all tests pass.
    Run `npx vitest run test/integration/refinement.test.ts` — all tests pass.
    Run `npx vitest run test/integration/` — all integration tests pass (including existing ones, no regressions).
  </verify>
  <done>
    E2E flow test verifies complete plugin lifecycle from fresh workspace through audit chain verification. Developer install path test validates standalone API reaches a functional clinical agent. Refinement integration test confirms the full observe -> propose -> resolve -> CANS.md update cycle works with real files. Error and tampered CANS.md paths are also covered.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create security review tests exercising all six hardening layers with adversarial scenarios</name>
  <files>
    test/integration/security-review.test.ts
  </files>
  <action>
    Create `test/integration/security-review.test.ts`:

    This test file validates INTG-02: Security review confirms all six hardening layers correctly block unauthorized actions in realistic scenarios. Use the established integration test patterns from `test/integration/hardening.test.ts`.

    Setup: Create temp workspace with `createTestWorkspace(dir)`, create real `AuditPipeline(dir)`, create real `HardeningEngine` via `createHardeningEngine()`, activate with the synthetic neurosurgeon CANS document.

    **Layer 1: Tool Policy Lockdown (HARD-01)**
    1. `it('blocks prohibited tools when CANS is active')`:
       - Call `engine.check({ toolName: 'WebSearch', params: {} })` (WebSearch is not in neurosurgeon's permitted tools)
       - Assert: `result.allowed === false`
       - Assert: result mentions tool-policy or layer 1

    2. `it('allows tools in the permitted set')`:
       - Call `engine.check({ toolName: 'Read', params: {} })` (Read is in the default allowed set)
       - Assert: `result.allowed === true`

    **Layer 2: Exec Allowlist (HARD-02)**
    3. `it('blocks unlisted exec commands')`:
       - Call `engine.check({ toolName: 'Bash', params: { command: 'rm -rf /' } })`
       - Assert: `result.allowed === false`
       - Assert: result mentions exec-allowlist or layer 2

    4. `it('allows read-only utilities')`:
       - Call `engine.check({ toolName: 'Bash', params: { command: 'cat /etc/hostname' } })`
       - Assert: `result.allowed === true`

    **Layer 3: CANS Protocol Injection (HARD-03)**
    5. `it('injects protocol rules into bootstrap context')`:
       - Access the bootstrap handler registered on the mock adapter
       - Call it with a mock context that has an `addFile` function
       - Assert: `addFile` was called with content containing provider name and scope rules

    **Layer 4: Docker Sandbox Detection (HARD-04)**
    6. `it('reports Docker status without blocking')`:
       - Call `engine.check()` on any tool
       - Assert: audit log contains a Docker/sandbox-related entry
       - Assert: Layer 4 never returns `allowed: false` (report-only)

    **Layer 5: Safety Guard (HARD-05)**
    7. `it('engine short-circuits on first deny')`:
       - Call `engine.check()` on a prohibited tool
       - Read audit log entries for this check — should show the denying layer but not subsequent layers

    **Layer 6: Audit Trail Integration (HARD-06)**
    8. `it('every layer check result is logged to AUDIT.log')`:
       - Perform a tool check (allowed)
       - Read AUDIT.log, parse entries
       - Assert: hardening_check action entry exists with layer information

    **Adversarial Scenarios**
    9. `it('blocks tool call that would violate scope boundaries')`:
       - Construct a tool call simulating an action outside the neurosurgeon's scope (e.g., a tool targeting an action listed in `prohibited_actions`)
       - Assert: check returns `allowed: false`

    10. `it('detects tampered audit log via chain verification')`:
        - Write several audit entries normally via the pipeline
        - Manually edit one line in the AUDIT.log file (corrupt a hash or change content)
        - Call `audit.verifyChain()` (or read the file and verify hash chain manually)
        - Assert: chain verification detects the tampering (returns false or an error)

    11. `it('rejects skill with modified files after integrity check')`:
        - Create a temp workspace with a skill directory containing a valid `skill-manifest.json` with file checksums
        - Create the skill files matching the checksums
        - Modify one skill file content after creating the manifest
        - Call `verifySkillIntegrity()` from `src/skills/integrity.ts`
        - Assert: integrity check fails (skill would not load)

    12. `it('refinement engine refuses to propose scope changes')`:
        - Create refinement engine
        - Record 10+ observations with `field_path: 'scope.prohibited_actions'`
        - Call `generateProposals()`
        - Assert: zero proposals generated (scope is sacrosanct)

    13. `it('refinement engine applyProposal throws on scope field')`:
        - Attempt to directly resolve a manually crafted proposal targeting a scope field
        - Assert: throws Error mentioning "SAFETY VIOLATION" or "scope"

    All tests should clean up temp directories in `afterEach` blocks using `rmSync(dir, { recursive: true, force: true })`.
  </action>
  <verify>
    Run `npx vitest run test/integration/security-review.test.ts` — all tests pass.
    Run `npx vitest run test/integration/` — all integration tests pass (no regressions).
    Run `npx vitest run` — full test suite passes.
    Count total test files: should be 42 existing + 3 new = 45 (approximately; exact count may differ if test consolidation happened).
  </verify>
  <done>
    Security review tests exercise all six hardening layers with both permitted and denied scenarios. Adversarial tests cover audit log tampering detection, skill file integrity, scope violation blocking, and refinement engine scope protection. Every hardening layer is verified to function correctly in an integrated environment with the synthetic neurosurgeon persona.
  </done>
</task>

</tasks>

<verification>
- `npx vitest run test/integration/` — all integration tests pass (new + existing)
- `npx vitest run` — full test suite passes with zero regressions
- E2E flow test covers: fresh workspace activation, inactive mode, malformed CANS, tampered CANS
- Security review covers all 6 hardening layers plus 5 adversarial scenarios
- Developer install path validates standalone API surface
- Refinement integration tests verify full lifecycle (observe -> propose -> accept -> CANS.md updated)
- All tests use realistic synthetic neurosurgeon persona
</verification>

<success_criteria>
- E2E flow test passes with fresh workspace through complete plugin lifecycle
- Security review validates all six hardening layers block unauthorized actions
- Adversarial scenarios detect tampering (audit logs, skill files, scope violations)
- Standalone activate() returns a fully functional clinical agent result
- Refinement engine correctly modifies CANS.md on accepted proposals and preserves integrity
- Zero test regressions across the entire 600+ test suite
</success_criteria>

<output>
After completion, create `.planning/phases/05-cans-continuous-improvement-and-integration/05-03-SUMMARY.md`
</output>
