---
phase: 04-clinical-skills
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/credentials/validator.ts
  - test/unit/credentials/credentials.test.ts
autonomous: true

must_haves:
  truths:
    - "Credential validator accepts a CANSDocument and required credentials, returning whether the provider qualifies"
    - "A provider whose license type is not in the required list is rejected with a clear reason"
    - "A provider whose specialty (or subspecialty) matches at least one required specialty passes"
    - "A provider missing required privileges is rejected with the specific missing privileges listed"
    - "When no credential requirements are specified for a dimension, that dimension passes automatically"
    - "Regular OpenClaw skills (no credential requirements) always pass credential validation"
  artifacts:
    - path: "src/credentials/validator.ts"
      provides: "Real CredentialValidator implementation replacing Phase 4 stub"
      exports: ["createCredentialValidator"]
    - path: "test/unit/credentials/credentials.test.ts"
      provides: "Comprehensive credential validation tests"
      min_lines: 80
  key_links:
    - from: "src/credentials/validator.ts"
      to: "src/credentials/types.ts"
      via: "implements CredentialValidator interface"
      pattern: "CredentialValidator"
    - from: "src/credentials/validator.ts"
      to: "src/activation/cans-schema.ts"
      via: "uses CANSDocument type for provider credential access"
      pattern: "CANSDocument"
---

<objective>
Replace the credential validator stub with a real implementation that checks provider credentials (license type, specialty, privileges) against a skill's required credentials.

Purpose: SKIL-01 (credential gating) and SKIL-02 (regular skills unaffected) depend on a working credential validator. This is the foundation that the skill loader (Plan 04) will use to gate clinical skills at load time.

Output: Working `createCredentialValidator()` factory and comprehensive tests.
</objective>

<execution_context>
@/Users/thomasanderson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomasanderson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/credentials/types.ts
@src/credentials/validator.ts
@src/credentials/index.ts
@src/activation/cans-schema.ts
@test/unit/credentials/credentials.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement credential validator</name>
  <files>src/credentials/validator.ts</files>
  <action>
Replace the stub `createCredentialValidator()` with a real implementation that satisfies the `CredentialValidator` interface from `./types.ts`.

The `check(cans, requiredCredentials)` method must:

1. **License check:** If `requiredCredentials.license` is a non-empty array, verify `cans.provider.license.type` is included. If not, add `license:MD|DO` (joined required values) to missing list.

2. **Specialty check:** If `requiredCredentials.specialty` is a non-empty array, check if `cans.provider.specialty` OR `cans.provider.subspecialty` (if present) matches any required specialty. If no match, add `specialty:Neurosurgery|Orthopedics` (joined) to missing list.

3. **Privilege check:** If `requiredCredentials.privilege` is a non-empty array, filter for privileges NOT in `cans.provider.privileges`. If any missing, add `privilege:surgical_procedures,craniotomy` (joined missing) to missing list.

4. **Return value:** Return `CredentialCheckResult` with:
   - `valid`: true if missing is empty
   - `provider`: `cans.provider.name`
   - `licenseType`: `cans.provider.license.type`
   - `specialty`: `cans.provider.specialty`
   - `missingCredentials`: array of missing strings (only if any)
   - `reason`: human-readable string (only if invalid)

5. **Empty/undefined requirements:** If a dimension's array is empty or undefined, that dimension passes automatically. This is how regular OpenClaw skills (which have no credential requirements) pass -- all three dimensions are empty.

Keep the implementation synchronous (no async). All data is local. Use the spread-conditional pattern for optional fields (consistent with existing codebase patterns).

Do NOT import anything new. The existing imports (`CredentialValidator` from `./types.js`) are sufficient.
  </action>
  <verify>npx vitest run test/unit/credentials/ --reporter=verbose</verify>
  <done>createCredentialValidator() returns a working validator that correctly gates on license, specialty, and privileges</done>
</task>

<task type="auto">
  <name>Task 2: Comprehensive credential validation tests</name>
  <files>test/unit/credentials/credentials.test.ts</files>
  <action>
Replace the existing stub tests with comprehensive tests for the real credential validator.

Create a `makeCANS()` helper that returns a valid `CANSDocument` with these defaults:
- `provider.name`: "Dr. Test"
- `provider.license.type`: "MD"
- `provider.license.state`: "CA"
- `provider.license.number`: "12345"
- `provider.license.verified`: false
- `provider.specialty`: "Neurosurgery"
- `provider.subspecialty`: "Spine"
- `provider.privileges`: ["surgical_procedures", "craniotomy", "spinal_fusion"]
- All other required CANS fields (scope, autonomy, hardening, consent, version) filled with valid defaults

The helper should accept a partial override object so tests can customize specific fields.

Write tests covering:

**License gating:**
- MD provider passes when license requires ["MD", "DO"]
- DO provider passes when license requires ["MD", "DO"]
- NP provider fails when license requires ["MD", "DO"] (missing: license:MD|DO)
- Empty license requirement passes any provider
- Undefined license requirement passes any provider

**Specialty gating:**
- Provider with matching specialty passes
- Provider with matching subspecialty passes (subspecialty matches required specialty)
- Provider with neither matching specialty nor subspecialty fails
- Provider with no subspecialty and non-matching specialty fails
- Empty specialty requirement passes any provider

**Privilege gating:**
- Provider with all required privileges passes
- Provider missing one privilege fails (lists the missing one)
- Provider missing multiple privileges fails (lists all missing)
- Empty privilege requirement passes

**Combined checks:**
- Provider failing multiple dimensions lists all missing credentials
- Provider passing all dimensions returns valid: true with no missingCredentials/reason
- All dimensions empty/undefined = valid (regular skill scenario)

**Return value shape:**
- Valid result has provider name, licenseType, specialty
- Invalid result has missingCredentials array and reason string
- Valid result does NOT have missingCredentials or reason properties (not just undefined -- not present)

Import `createCredentialValidator` from `../../../src/credentials/validator.js` and types as needed from `../../../src/credentials/types.js`.
  </action>
  <verify>npx vitest run test/unit/credentials/ --reporter=verbose && echo "All credential tests pass"</verify>
  <done>All credential validation tests pass covering license, specialty, privilege, combined, and edge cases</done>
</task>

</tasks>

<verification>
- `npx vitest run test/unit/credentials/` passes all tests
- `npx vitest run` still passes all existing 486+ tests (no regressions)
- `npm run build` succeeds
</verification>

<success_criteria>
- createCredentialValidator() returns a working validator (not a stub)
- License, specialty, and privilege checks work independently and combined
- Empty/undefined requirements pass automatically (SKIL-02: regular skills unaffected)
- All tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/04-clinical-skills/04-01-SUMMARY.md`
</output>
