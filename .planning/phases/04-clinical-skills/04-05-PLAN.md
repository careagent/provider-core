---
phase: 04-clinical-skills
plan: 05
type: execute
wave: 3
depends_on: ["04-03", "04-04"]
files_modified:
  - src/entry/openclaw.ts
  - src/entry/standalone.ts
  - src/entry/core.ts
  - src/skills/index.ts
  - openclaw.plugin.json
  - test/integration/skills.test.ts
autonomous: true

must_haves:
  truths:
    - "OpenClaw entry point loads clinical skills after hardening activation and registers approved skill directories"
    - "Standalone entry point loads clinical skills and exposes loaded skill results on ActivateResult"
    - "Core entry point re-exports the complete skills public API"
    - "Skills module index re-exports chart-skill functions"
    - "A provider without required credentials sees no clinical skills loaded (and this is audit-logged)"
    - "A provider with valid credentials sees chart-skill loaded (and this is audit-logged)"
    - "A modified skill file causes the skill to not load (integrity check failure in integration)"
    - "A pinned skill with mismatched approved_version is blocked from loading (SKIL-04 in integration)"
    - "openclaw.plugin.json references the skills directory"
    - "Full integration test verifies credential gating, version pinning, integrity verification, and audit trail end-to-end"
  artifacts:
    - path: "src/entry/openclaw.ts"
      provides: "Skill loading step after hardening activation"
      contains: "loadClinicalSkills"
    - path: "src/entry/standalone.ts"
      provides: "Skill loading with results exposed on ActivateResult"
      contains: "loadClinicalSkills"
    - path: "src/entry/core.ts"
      provides: "Complete skills API re-exports"
      contains: "skills/index"
    - path: "src/skills/index.ts"
      provides: "Complete module re-exports including chart-skill"
      contains: "chart-skill"
    - path: "test/integration/skills.test.ts"
      provides: "End-to-end integration tests for skill loading pipeline"
      min_lines: 80
  key_links:
    - from: "src/entry/openclaw.ts"
      to: "src/skills/loader.ts"
      via: "calls loadClinicalSkills after hardening activation"
      pattern: "loadClinicalSkills"
    - from: "src/entry/openclaw.ts"
      to: "src/credentials/validator.ts"
      via: "creates CredentialValidator for skill loading"
      pattern: "createCredentialValidator"
    - from: "src/entry/standalone.ts"
      to: "src/skills/loader.ts"
      via: "calls loadClinicalSkills in active mode"
      pattern: "loadClinicalSkills"
    - from: "test/integration/skills.test.ts"
      to: "src/skills/loader.ts"
      via: "end-to-end test of full loading pipeline"
      pattern: "loadClinicalSkills"
---

<objective>
Wire the skill loading pipeline into both entry points (openclaw.ts, standalone.ts), update core.ts re-exports, finalize the skills module index, and write end-to-end integration tests.

Purpose: This plan connects all the pieces built in Plans 01-04 into the running system. After this plan, clinical skills actually load (or are blocked) when CareAgent activates. Integration tests verify the entire pipeline works end-to-end.

Output: Updated entry points with skill loading, complete module re-exports, and integration tests.
</objective>

<execution_context>
@/Users/thomasanderson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomasanderson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/entry/openclaw.ts
@src/entry/standalone.ts
@src/entry/core.ts
@src/skills/index.ts
@src/credentials/validator.ts
@src/audit/pipeline.ts
@openclaw.plugin.json
@test/integration/skills.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire skill loading into entry points and update re-exports</name>
  <files>src/entry/openclaw.ts, src/entry/standalone.ts, src/entry/core.ts, src/skills/index.ts, openclaw.plugin.json</files>
  <action>
**Update `src/entry/openclaw.ts`:**

Add imports at the top:
- `import { createCredentialValidator } from '../credentials/validator.js';`
- `import { loadClinicalSkills } from '../skills/loader.js';`
- `import { join } from 'node:path';`

After Step 6 (hardening engine activation) and before Step 7 (audit integrity service), add Step 6.5:

```typescript
// Step 6.5: Load clinical skills (SKIL-01 through SKIL-07)
const validator = createCredentialValidator();
const skillsDir = join(__dirname, '..', 'skills'); // Resolve skills/ relative to dist/entry/
// Note: __dirname resolves to dist/entry/ at runtime; skills/ is at repo root
// Actually, skills ship inside the plugin package, so they'll be at the package root
// Use a more reliable resolution: relative to the package root
```

Wait -- the skills directory path resolution needs careful thought. In the built package:
- `dist/entry/openclaw.js` is the entry point
- `skills/chart-skill/` is at the package root

So from `dist/entry/openclaw.js`, the skills directory is at `../../skills/` (up two levels from dist/entry/).

Use `join(__dirname, '..', '..', 'skills')` to resolve from `dist/entry/` to the package root's `skills/` directory.

But `__dirname` may not work in ESM. Since the project uses `"type": "module"`, use `import.meta.url` with `fileURLToPath`:

```typescript
import { fileURLToPath } from 'node:url';
import { dirname, join } from 'node:path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
```

Or simpler: accept the skills directory as a parameter or resolve it from the workspace path. Actually, the research says: "ship the chart-skill inside the plugin repo at `skills/chart-skill/`" and "the `openclaw.plugin.json` `skills` array should list `["skills/chart-skill"]` -- but only after credential and integrity checks pass."

The cleanest approach for v1: resolve skills directory relative to the plugin package root using `import.meta.url`. Add at the top of the file:

```typescript
import { fileURLToPath } from 'node:url';
import { dirname, join } from 'node:path';
```

Then in the skill loading step:

```typescript
const pluginRoot = join(dirname(fileURLToPath(import.meta.url)), '..', '..');
const skillsDir = join(pluginRoot, 'skills');
const validator = createCredentialValidator();
const skillResults = loadClinicalSkills(skillsDir, cans, validator, audit);

const loadedSkills = skillResults.filter(r => r.loaded);
const blockedSkills = skillResults.filter(r => !r.loaded);

if (loadedSkills.length > 0) {
  adapter.log('info', `[CareAgent] Loaded ${loadedSkills.length} clinical skill(s): ${loadedSkills.map(s => s.skillId).join(', ')}`);
}
if (blockedSkills.length > 0) {
  adapter.log('warn', `[CareAgent] Blocked ${blockedSkills.length} clinical skill(s): ${blockedSkills.map(s => `${s.skillId} (${s.reason})`).join(', ')}`);
}
```

Note: Do NOT try to dynamically modify `openclaw.plugin.json` at runtime. The plugin manifest is read by OpenClaw at install time, not at runtime. Instead, the loaded skill directories should be registered via the adapter's skill registration API if available, or via OpenClaw's runtime skill loading mechanism. For v1, the skill loading pipeline validates and logs -- the SKILL.md is injected via the bootstrap hook (already handled by the hardening engine's protocol injection). The chart-skill's SKILL.md content will be injected separately via the bootstrap hook.

Actually, re-reading the research more carefully: "the plugin's register() function checks credentials and integrity before declaring skill directories in the plugin manifest, effectively gating which skills OpenClaw sees." And "OpenClaw skills live in... plugin-declared directories."

For v1, wrap skill loading in a try/catch for resilience. If the skills directory doesn't exist (e.g., not yet installed), log and continue. Do NOT crash the plugin.

```typescript
try {
  const pluginRoot = join(dirname(fileURLToPath(import.meta.url)), '..', '..');
  const skillsDir = join(pluginRoot, 'skills');
  const validator = createCredentialValidator();
  const skillResults = loadClinicalSkills(skillsDir, cans, validator, audit);
  // ... logging ...
} catch (err) {
  const msg = err instanceof Error ? err.message : String(err);
  adapter.log('warn', `[CareAgent] Skill loading failed: ${msg}`);
  audit.log({ action: 'skill_load', actor: 'system', outcome: 'error', details: { error: msg } });
}
```

**Update `src/entry/standalone.ts`:**

Add the same imports. In the `if (activation.active)` block, after hardening engine activation, add skill loading:

```typescript
import { createCredentialValidator } from '../credentials/validator.js';
import { loadClinicalSkills } from '../skills/loader.js';
import type { SkillLoadResult } from '../skills/types.js';
```

Update the `ActivateResult` interface to include `skills?: SkillLoadResult[]`.

After engine activation:
```typescript
let skills: SkillLoadResult[] = [];
try {
  const pluginRoot = join(dirname(fileURLToPath(import.meta.url)), '..', '..');
  const skillsDir = join(pluginRoot, 'skills');
  const validator = createCredentialValidator();
  skills = loadClinicalSkills(skillsDir, activation.document!, validator, audit);
} catch {
  // Skills loading is non-fatal in standalone mode
}
return { adapter, audit, activation, engine, skills };
```

Add `import { fileURLToPath } from 'node:url'` and `import { dirname, join } from 'node:path'`.

**Update `src/entry/core.ts`:**

Add a skills section after the credentials section:

```typescript
// Skills (implementation — Phase 4)
export type { SkillManifest, SkillLoadResult, ChartTemplate, TemplateSection, VoiceDirectives } from '../skills/index.js';
export { SkillManifestSchema, validateManifest } from '../skills/index.js';
export { computeSkillFileHash, computeSkillChecksums, verifySkillIntegrity } from '../skills/index.js';
export { checkVersionPin, approveVersion } from '../skills/index.js';
export { loadClinicalSkills } from '../skills/index.js';
export { getTemplate, getAllTemplates, CHART_SKILL_ID, buildChartSkillInstructions } from '../skills/index.js';
export { extractVoiceDirectives, buildVoiceInstructions } from '../skills/index.js';
```

Update the credentials comment from "interface-only -- implementation in Phase 4" to "implementation -- Phase 4".

**Update `src/skills/index.ts`:**

Add the chart-skill re-exports that were deferred from Plan 04:

```typescript
// Chart-skill
export { getTemplate, getAllTemplates, CHART_SKILL_ID, buildChartSkillInstructions } from './chart-skill/index.js';
export { extractVoiceDirectives, buildVoiceInstructions } from './chart-skill/voice-adapter.js';
```

**Update `openclaw.plugin.json`:**

Add the skills directory reference. This tells OpenClaw where to find plugin-provided skills:

```json
{
  "id": "@careagent/provider-core",
  "name": "CareAgent",
  "description": "Clinical activation layer — transforms OpenClaw into a credentialed, auditable clinical agent",
  "version": "0.1.0",
  "configSchema": {},
  "skills": ["skills/chart-skill"],
  "commands": [],
  "hooks": []
}
```

Note: This declares the skill directory path. CareAgent's runtime gating decides whether the skill actually loads based on credentials and integrity.
  </action>
  <verify>npm run build && npx vitest run test/unit/ --reporter=verbose</verify>
  <done>Skill loading wired into both entry points, core.ts re-exports complete, openclaw.plugin.json updated</done>
</task>

<task type="auto">
  <name>Task 2: End-to-end integration tests</name>
  <files>test/integration/skills.test.ts</files>
  <action>
Create integration tests that verify the complete skill loading pipeline end-to-end.

Use the same patterns established in Phase 3 integration tests (real temp workspaces, real AuditPipeline, mock adapter).

**Setup:**

```typescript
import { mkdtempSync, writeFileSync, mkdirSync, readFileSync, rmSync } from 'node:fs';
import { join } from 'node:path';
import { tmpdir } from 'node:os';
import { createHash } from 'node:crypto';
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { AuditPipeline } from '../../src/audit/pipeline.js';
import { createCredentialValidator } from '../../src/credentials/validator.js';
import { loadClinicalSkills } from '../../src/skills/loader.js';
import type { CANSDocument } from '../../src/activation/cans-schema.js';
```

Create helpers:
- `makeWorkspace()`: creates temp dir with `.careagent/` subdirectory, returns path
- `makeSkillsDir(workspace)`: creates `skills/` subdirectory in workspace
- `addTestSkill(skillsDir, skillId, opts)`: creates a skill directory with SKILL.md and computed-hash manifest
- `makeCANS(overrides)`: returns valid CANSDocument (MD, Neurosurgery, with privileges)
- `readAuditLog(workspace)`: reads `.careagent/AUDIT.log`, splits lines, parses JSON, returns array

**Test cases:**

**SKIL-01: Credential gating end-to-end:**
- Create workspace, skills dir, chart-skill-like skill requiring ["MD", "DO"]
- Load with MD provider CANS -> skill loaded
- Load with NP provider CANS -> skill blocked
- Audit log contains correct credential check entries for both cases

**SKIL-02: Regular skills unaffected:**
- Create workspace with a skill directory that has SKILL.md but NO skill-manifest.json
- Load skills -> no results for that directory (it's a regular OpenClaw skill, not CareAgent-managed)
- No audit entries about it

**SKIL-03: Integrity verification end-to-end:**
- Create workspace, add skill with correct checksums -> loads
- Modify the SKILL.md content after creating manifest with original hash -> fails integrity check
- Audit log contains integrity check denied entry with hash mismatch reason

**SKIL-04: Version pinning end-to-end:**
- Create workspace, add skill with `pinned: true`, `version: '1.0.0'`, `approved_version: '1.0.0'` -> loads (versions match)
- Create workspace, add skill with `pinned: true`, `version: '1.1.0'`, `approved_version: '1.0.0'` -> blocked, reason includes 'Version update requires approval'
- Audit log contains skill_version_check with outcome: 'denied' for the mismatched case
- Audit log for the blocked case does NOT contain skill_credential_check or skill_integrity_check entries (version pin blocks before those steps)

**SKIL-07: Audit trail completeness:**
- Create workspace, add skill that passes all checks
- Load skills
- Read AUDIT.log
- Verify entries in order: skill_discovery, skill_version_check (allowed), skill_credential_check (allowed), skill_integrity_check (allowed), skill_load (allowed)
- Verify each entry has session_id, timestamp, and correct details

**Multiple skills with mixed outcomes:**
- Add two skills: one requiring MD (provider has MD) and one requiring specialty "Dermatology" (provider is Neurosurgery)
- Load both: first loads, second blocked
- Audit log shows both outcomes

**CANS.md skills.rules integration:**
- Create CANS with `skills: { rules: [{ skill_id: 'test-skill', requires_privilege: ['laser_surgery'] }] }`
- Add skill with no privilege requirements in manifest
- Load fails because CANS rules add the privilege requirement the provider doesn't have
- Audit log shows denial with cans_rules source

**Hash chain integrity:**
- After loading skills, verify the audit chain is intact: `audit.verifyChain()` returns valid: true

Clean up all temp directories in afterEach.
  </action>
  <verify>npx vitest run test/integration/skills.test.ts --reporter=verbose</verify>
  <done>All integration tests pass verifying credential gating, version pinning, integrity verification, audit logging, and CANS rules end-to-end</done>
</task>

</tasks>

<verification>
- `npx vitest run` passes ALL tests (unit + integration, existing + new)
- `npm run build` succeeds with all 4 entry points
- Audit log entries are correctly chained (verifyChain passes)
- Entry points load skills after hardening activation
- Core entry point exports complete skills API
</verification>

<success_criteria>
- openclaw.ts loads clinical skills after hardening activation
- standalone.ts exposes skill load results on ActivateResult
- core.ts re-exports the complete skills API
- Integration tests verify all 7 SKIL requirements end-to-end (including SKIL-04 version pinning)
- All 486+ existing tests still pass (no regressions)
- Build succeeds with all 4 entry points
</success_criteria>

<output>
After completion, create `.planning/phases/04-clinical-skills/04-05-SUMMARY.md`
</output>
