---
phase: 04-clinical-skills
plan: 04
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - src/skills/loader.ts
  - src/skills/index.ts
  - test/unit/skills/loader.test.ts
autonomous: true

must_haves:
  truths:
    - "Skill loader discovers skill directories, reads their manifests, and validates them"
    - "Skills that fail credential validation are not loaded; a clear reason is returned"
    - "Skills that fail integrity verification are not loaded; a clear reason is returned"
    - "Skills with no credential requirements load for any provider (SKIL-02: regular skills unaffected)"
    - "Every credential check, integrity check, and load decision is audit-logged"
    - "CANS.md skills.rules can add additional restrictions beyond manifest requirements (union, not override)"
    - "Loaded skills return their directory path for OpenClaw registration"
    - "Pinned skills with a mismatched approved_version are blocked from loading (SKIL-04: version pinning enforced)"
  artifacts:
    - path: "src/skills/loader.ts"
      provides: "Skill discovery, credential gating, version pin enforcement, integrity verification, and loading pipeline"
      exports: ["loadClinicalSkills"]
      min_lines: 60
    - path: "src/skills/index.ts"
      provides: "Skills module re-exports"
      exports: ["loadClinicalSkills", "SkillManifestSchema", "verifySkillIntegrity", "computeSkillChecksums", "checkVersionPin", "approveVersion"]
    - path: "test/unit/skills/loader.test.ts"
      provides: "Comprehensive loader tests with temp skill directories"
      min_lines: 100
  key_links:
    - from: "src/skills/loader.ts"
      to: "src/credentials/validator.ts"
      via: "calls validator.check() for credential gating"
      pattern: "validator\\.check"
    - from: "src/skills/loader.ts"
      to: "src/skills/integrity.ts"
      via: "calls verifySkillIntegrity for file hash verification"
      pattern: "verifySkillIntegrity"
    - from: "src/skills/loader.ts"
      to: "src/skills/version-pin.ts"
      via: "calls checkVersionPin for SKIL-04 version pinning enforcement"
      pattern: "checkVersionPin"
    - from: "src/skills/loader.ts"
      to: "src/audit/pipeline.ts"
      via: "audit.log() for every skill lifecycle event"
      pattern: "audit\\.log"
    - from: "src/skills/loader.ts"
      to: "src/skills/manifest-schema.ts"
      via: "validateManifest for manifest parsing"
      pattern: "validateManifest"
---

<objective>
Create the skill loader that composes credential validation, version pin enforcement, integrity verification, and manifest parsing into a single pipeline. This is the core of the skill framework that gates clinical skills at load time.

Purpose: The loader is the integration point for SKIL-01 (credential gating), SKIL-02 (regular skills pass), SKIL-03 (integrity verification), SKIL-04 (version pinning), and SKIL-07 (audit logging). It reads skill directories, validates credentials, enforces version pins, verifies integrity, and returns which skills should be registered with OpenClaw.

Output: `loadClinicalSkills()` function and module re-exports with comprehensive tests.
</objective>

<execution_context>
@/Users/thomasanderson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomasanderson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/credentials/types.ts
@src/skills/types.ts
@src/skills/manifest-schema.ts
@src/skills/integrity.ts
@src/skills/version-pin.ts
@src/activation/cans-schema.ts
@src/audit/pipeline.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Skill loader implementation</name>
  <files>src/skills/loader.ts, src/skills/index.ts</files>
  <action>
**Create `src/skills/loader.ts`:**

Import:
- `readFileSync, existsSync, readdirSync` from `node:fs`
- `join` from `node:path`
- `CANSDocument` type from `../activation/cans-schema.js`
- `CredentialValidator` type from `../credentials/types.js`
- `AuditPipeline` type from `../audit/pipeline.js`
- `SkillManifest, SkillLoadResult` from `./types.js`
- `validateManifest` from `./manifest-schema.js`
- `verifySkillIntegrity` from `./integrity.js`
- `checkVersionPin` from `./version-pin.js`

Export `loadClinicalSkills(skillsBaseDir: string, cans: CANSDocument, validator: CredentialValidator, audit: AuditPipeline): SkillLoadResult[]`

The function implements a six-step pipeline (with step 2.5 for version pinning):

1. **Discovery:** Read `skillsBaseDir` with `readdirSync({ withFileTypes: true })`. For each subdirectory, check if it contains a `skill-manifest.json`. If not, it's a regular OpenClaw skill -- skip it (return no result for it; regular skills are not CareAgent-managed). Audit-log discovery: `{ action: 'skill_discovery', outcome: 'active', details: { skill_id, version, directory } }`.

2. **Manifest validation:** Read and parse `skill-manifest.json`. Use `validateManifest()`. If invalid, add `{ skillId: dirName, loaded: false, reason: 'Invalid manifest: ...' }` to results. Audit-log: `{ action: 'skill_load', outcome: 'denied', details: { skill_id: dirName, reason } }`. Continue to next skill.

2.5. **Version pin check (SKIL-04):** Call `checkVersionPin(manifest)`. If `updateAvailable` is true (meaning the manifest version does not match the approved_version), the skill MUST be blocked. Add `{ skillId: manifest.skill_id, loaded: false, reason: 'Version update requires approval: current v{manifest.version}, approved v{manifest.approved_version}' }` to results. Audit-log: `{ action: 'skill_version_check', outcome: 'denied', details: { skill_id: manifest.skill_id, current_version: manifest.version, approved_version: manifest.approved_version } }`. Continue to next skill. If version pin passes (updateAvailable is false), audit-log: `{ action: 'skill_version_check', outcome: 'allowed', details: { skill_id: manifest.skill_id, version: manifest.version, pinned: manifest.pinned } }`.

3. **Credential check:** Call `validator.check(cans, manifest.requires)`. If not valid, add `{ skillId: manifest.skill_id, loaded: false, reason: result.reason }` to results. Audit-log: `{ action: 'skill_credential_check', outcome: 'denied', details: { skill_id, missing_credentials: result.missingCredentials, reason: result.reason } }`. Continue to next skill. If valid, audit-log: `{ action: 'skill_credential_check', outcome: 'allowed', details: { skill_id, provider: result.provider, license: result.licenseType, specialty: result.specialty } }`.

4. **CANS.md skills.rules augmentation:** If `cans.skills?.rules` exists, find any rule matching `manifest.skill_id`. If found, merge the rule's requirements with the manifest's requirements (union -- take the union of required licenses, specialties, privileges). Run `validator.check()` again with the merged requirements. If this fails, add blocked result. Audit-log with `action: 'skill_credential_check'` and `details: { source: 'cans_rules' }`.

5. **Integrity verification:** Call `verifySkillIntegrity(skillDir, manifest)`. If not valid, add `{ skillId: manifest.skill_id, loaded: false, reason: integrityResult.reason }` to results. Audit-log: `{ action: 'skill_integrity_check', outcome: 'denied', details: { skill_id, reason } }`. Continue to next skill. If valid, audit-log: `{ action: 'skill_integrity_check', outcome: 'allowed', details: { skill_id, version: manifest.version } }`.

6. **Success:** Add `{ skillId: manifest.skill_id, loaded: true, version: manifest.version, directory: skillDir }` to results. Audit-log: `{ action: 'skill_load', outcome: 'allowed', details: { skill_id: manifest.skill_id, version: manifest.version } }`.

Return the results array. The function is synchronous (all data is local -- no network I/O). This is important per Pitfall 1 in research.

**Create `src/skills/index.ts`:**

Re-export the public API:

```typescript
// Types
export type { SkillManifest, SkillLoadResult, ChartTemplate, TemplateSection, VoiceDirectives } from './types.js';

// Manifest validation
export { SkillManifestSchema, validateManifest } from './manifest-schema.js';

// Integrity
export { computeSkillFileHash, computeSkillChecksums, verifySkillIntegrity } from './integrity.js';

// Version pinning
export { checkVersionPin, approveVersion } from './version-pin.js';

// Loader
export { loadClinicalSkills } from './loader.js';

// Chart-skill
export { getTemplate, getAllTemplates, CHART_SKILL_ID, buildChartSkillInstructions } from './chart-skill/index.js';
export { extractVoiceDirectives, buildVoiceInstructions } from './chart-skill/voice-adapter.js';
```

Note: This index.ts imports from chart-skill, which is created in Plan 03 (same wave). If Plan 04 executes before Plan 03 completes, the chart-skill imports will fail to resolve. In that case, comment out the chart-skill re-exports with a `// TODO: uncomment when chart-skill is ready` note and move them to Plan 05 which runs after both. Better approach: include the chart-skill re-exports but accept that the build may show warnings. The test for this plan only tests loader.ts, not the full module build. Plan 05 will ensure everything works together.

Actually, the cleanest approach: split `src/skills/index.ts` into two sections. Export everything except chart-skill now. Plan 05 (Wave 3) will add the chart-skill re-exports when it wires everything together.
  </action>
  <verify>npx vitest run test/unit/skills/loader.test.ts --reporter=verbose</verify>
  <done>loadClinicalSkills correctly gates skills based on credentials, version pins, and integrity, audit-logs every decision</done>
</task>

<task type="auto">
  <name>Task 2: Comprehensive loader tests</name>
  <files>test/unit/skills/loader.test.ts</files>
  <action>
Create comprehensive tests for the skill loader using real temp directories.

**Test setup:**

Create helpers:
- `makeTempSkillsDir()`: uses `mkdtempSync` to create a temp base dir, returns path
- `addSkill(baseDir, skillId, manifest, skillMdContent)`: creates `baseDir/skillId/`, writes `skill-manifest.json` and `SKILL.md`, computes real SHA-256 hash of SKILL.md and puts it in the manifest's `files` field before writing
- `makeCANS(overrides?)`: returns a valid CANSDocument (same pattern as Plan 01 tests -- MD, Neurosurgery, with privileges)
- `makeMockAudit()`: returns `{ audit: AuditPipeline-like-object, calls: [] }` where `log()` pushes to calls array for assertion. Use a real `AuditPipeline` with a temp workspace OR a simple mock with `log(input) { calls.push(input) }`. A mock is simpler since we're unit-testing the loader, not the audit pipeline.

For the mock audit, create a minimal object that satisfies the AuditPipeline interface used by the loader (just the `log` method and `createTraceId`):
```typescript
function makeMockAudit() {
  const calls: AuditLogInput[] = [];
  return {
    audit: { log: (input: any) => calls.push(input), createTraceId: () => 'test-trace' },
    calls,
  };
}
```

Import `createCredentialValidator` from the real credential validator (Plan 01 must be complete). If running before Plan 01, the test will fail -- this is expected since Plan 04 depends on Plan 01.

**Test cases:**

**Credential gating (SKIL-01):**
- MD provider loads a skill requiring ["MD", "DO"] -- loaded: true
- NP provider fails to load a skill requiring ["MD", "DO"] -- loaded: false, reason mentions credentials
- Audit log contains skill_credential_check with outcome: 'allowed' for passing
- Audit log contains skill_credential_check with outcome: 'denied' for failing

**Regular skills (SKIL-02):**
- Skill directory without skill-manifest.json is skipped (not in results at all)
- Skill with empty requires (no license/specialty/privilege) loads for any provider

**Integrity verification (SKIL-03):**
- Skill with correct checksums loads successfully
- Skill with modified SKILL.md fails integrity check -- loaded: false
- Audit log contains skill_integrity_check with outcome for both cases

**Version pinning (SKIL-04):**
- Skill with `pinned: true` and `approved_version` matching `version` loads successfully
- Skill with `pinned: true` and `approved_version` NOT matching `version` (e.g., manifest.version is '1.1.0' but approved_version is '1.0.0') is blocked -- loaded: false, reason includes 'Version update requires approval'
- Skill with `pinned: false` or without pinning fields loads without version check blocking
- Audit log contains skill_version_check with outcome: 'denied' for mismatched version
- Audit log contains skill_version_check with outcome: 'allowed' for matching version

**CANS.md skills.rules augmentation:**
- CANS.md with skills.rules adding extra license requirement blocks the skill
- CANS.md without skills section does not affect loading
- Audit log shows source: 'cans_rules' for rules-based denial

**Manifest validation:**
- Skill with invalid manifest JSON fails with reason
- Skill with missing skill_id in manifest fails

**Audit logging (SKIL-07):**
- Successful load produces: skill_discovery, skill_version_check (allowed), skill_credential_check (allowed), skill_integrity_check (allowed), skill_load (allowed)
- Credential failure produces: skill_discovery, skill_version_check (allowed), skill_credential_check (denied), skill_load (denied)
- Integrity failure produces: skill_discovery, skill_version_check (allowed), skill_credential_check (allowed), skill_integrity_check (denied), skill_load (denied)
- Version pin failure produces: skill_discovery, skill_version_check (denied), skill_load (denied) -- no credential or integrity checks since version pin blocks first

**Multiple skills:**
- Loading directory with 2 skills where one passes and one fails returns correct results for each

Clean up temp directories in afterEach/afterAll.
  </action>
  <verify>npx vitest run test/unit/skills/loader.test.ts --reporter=verbose</verify>
  <done>All loader tests pass covering credential gating, version pin enforcement, integrity verification, CANS rules, manifest validation, and audit logging</done>
</task>

</tasks>

<verification>
- `npx vitest run test/unit/skills/loader.test.ts` passes all tests
- `npx vitest run` still passes all existing tests
- `npm run build` succeeds (may have warnings for chart-skill imports if Plan 03 not yet done)
</verification>

<success_criteria>
- loadClinicalSkills gates on credentials, version pins, integrity, and CANS rules
- Pinned skills with mismatched approved_version are blocked (SKIL-04 enforced)
- Regular OpenClaw skills (no manifest) are skipped, not blocked
- Every lifecycle event is audit-logged with correct action/outcome
- CANS.md skills.rules make gating stricter, never more permissive
- All tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/04-clinical-skills/04-04-SUMMARY.md`
</output>
