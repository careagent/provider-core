---
phase: 04-clinical-skills
plan: 03
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - src/skills/chart-skill/template-types.ts
  - src/skills/chart-skill/templates/operative-note.ts
  - src/skills/chart-skill/templates/h-and-p.ts
  - src/skills/chart-skill/templates/progress-note.ts
  - src/skills/chart-skill/voice-adapter.ts
  - src/skills/chart-skill/index.ts
  - skills/chart-skill/SKILL.md
  - skills/chart-skill/skill-manifest.json
  - test/unit/skills/chart-skill.test.ts
autonomous: true

must_haves:
  truths:
    - "Operative note template has all 16 required sections including neurosurgery-specific ones"
    - "H&P template has all 14 required sections including neurological examination"
    - "Progress note template has all 6 SOAP sections including neurological status"
    - "Voice adapter extracts directives from CANS clinical_voice and produces LLM instructions"
    - "Voice adapter handles missing/undefined clinical_voice gracefully"
    - "SKILL.md provides complete LLM instructions for template-constrained note generation"
    - "skill-manifest.json declares credential requirements and file checksums"
    - "getTemplate returns the correct template by ID or undefined for unknown IDs"
    - "getAllTemplates returns all three templates"
  artifacts:
    - path: "src/skills/chart-skill/templates/operative-note.ts"
      provides: "16-section operative note template with neurosurgery-specific sections"
      exports: ["operativeNoteTemplate"]
    - path: "src/skills/chart-skill/templates/h-and-p.ts"
      provides: "14-section H&P template with neurological examination"
      exports: ["hAndPTemplate"]
    - path: "src/skills/chart-skill/templates/progress-note.ts"
      provides: "6-section progress note template with neurological status"
      exports: ["progressNoteTemplate"]
    - path: "src/skills/chart-skill/voice-adapter.ts"
      provides: "Clinical voice extraction and LLM instruction generation"
      exports: ["extractVoiceDirectives", "buildVoiceInstructions"]
    - path: "src/skills/chart-skill/index.ts"
      provides: "Template registry and chart-skill public API"
      exports: ["getTemplate", "getAllTemplates", "CHART_SKILL_ID"]
    - path: "skills/chart-skill/SKILL.md"
      provides: "OpenClaw skill file with LLM instructions for chart generation"
    - path: "skills/chart-skill/skill-manifest.json"
      provides: "CareAgent metadata with credential requirements and integrity checksums"
  key_links:
    - from: "src/skills/chart-skill/voice-adapter.ts"
      to: "src/activation/cans-schema.ts"
      via: "imports ClinicalVoice type"
      pattern: "ClinicalVoice"
    - from: "src/skills/chart-skill/index.ts"
      to: "src/skills/chart-skill/templates/"
      via: "imports and registers all three templates"
      pattern: "operativeNoteTemplate|hAndPTemplate|progressNoteTemplate"
    - from: "src/skills/chart-skill/template-types.ts"
      to: "src/skills/types.ts"
      via: "re-exports or uses ChartTemplate and TemplateSection types"
      pattern: "ChartTemplate|TemplateSection"
---

<objective>
Create the chart-skill: three neurosurgery-specific clinical note templates, a voice adapter, and the OpenClaw SKILL.md that instructs the LLM to generate template-constrained documentation.

Purpose: SKIL-05 (template-constrained generation in provider's voice) and SKIL-06 (neurosurgery-specific templates) are implemented here. The chart-skill is the first clinical skill and the proof-of-concept for the skill framework.

Output: Complete chart-skill with templates, voice adapter, SKILL.md, and skill-manifest.json.
</objective>

<execution_context>
@/Users/thomasanderson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomasanderson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-clinical-skills/04-RESEARCH.md
@src/skills/types.ts
@src/activation/cans-schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clinical note templates and voice adapter</name>
  <files>src/skills/chart-skill/template-types.ts, src/skills/chart-skill/templates/operative-note.ts, src/skills/chart-skill/templates/h-and-p.ts, src/skills/chart-skill/templates/progress-note.ts, src/skills/chart-skill/voice-adapter.ts</files>
  <action>
**Create `src/skills/chart-skill/template-types.ts`:**

Re-export `ChartTemplate`, `TemplateSection`, and `VoiceDirectives` from `../types.js`. This keeps chart-skill imports clean without duplicating type definitions.

**Create `src/skills/chart-skill/templates/operative-note.ts`:**

Export `operativeNoteTemplate: ChartTemplate` with `templateId: 'operative-note'`, `name: 'Operative Note'`, `version: '1.0.0'`, and exactly 16 sections per the research findings:

1. Date of Procedure (required, text)
2. Preoperative Diagnosis (required, text)
3. Postoperative Diagnosis (required, text)
4. Procedure Performed (required, text)
5. Surgeon (required, text) -- description: "Name and credentials of primary surgeon"
6. Assistant(s) (optional, text)
7. Anesthesia (required, text)
8. Indications (required, text) -- description: "Clinical reason and necessity for the procedure"
9. Description of Procedure (required, text) -- description: "Step-by-step narrative of the surgical procedure including approach, positioning, and technique"
10. Findings (required, text) -- description: "Intraoperative findings including pathology encountered"
11. Specimens (optional, list)
12. Implants/Hardware (optional, list) -- description: "Implants, hardware, or devices placed (neurosurgery-specific)"
13. Estimated Blood Loss (required, text)
14. Fluids/Drains (optional, text) -- description: "IV fluids administered and drains placed (neurosurgery-specific)"
15. Neuromonitoring (optional, text) -- description: "Intraoperative neuromonitoring modalities and findings (neurosurgery-specific)"
16. Complications (required, text) -- description: 'Intraoperative complications or "None"'
17. Disposition (required, text) -- description: "Patient condition and disposition at end of procedure"

Note: The research listed 16 sections but the actual list has 17 entries (Surgeon and Assistant(s) were one item in research). Keep all 17 -- the research described them as combined but they are better as separate sections.

Wait -- re-reading the research: it lists 16 numbered items where #5 is "Surgeon / Assistant(s)" as one line. For template purposes, split these into separate sections (17 total) because the surgeon is required but assistant(s) are optional. This is more precise for template validation.

**Create `src/skills/chart-skill/templates/h-and-p.ts`:**

Export `hAndPTemplate: ChartTemplate` with `templateId: 'h-and-p'`, `name: 'History and Physical'`, `version: '1.0.0'`, and 14 sections:

1. Chief Complaint (required, text)
2. History of Present Illness (required, text)
3. Past Medical History (required, text)
4. Past Surgical History (required, text)
5. Medications (required, list)
6. Allergies (required, list)
7. Family History (optional, text)
8. Social History (optional, text)
9. Review of Systems (required, text)
10. Physical Examination (required, text)
11. Neurological Examination (required, text) -- description: "Detailed neurological examination including mental status, cranial nerves, motor, sensory, reflexes, coordination, gait (neurosurgery-specific)"
12. Imaging/Studies (required, text) -- description: "Relevant imaging and laboratory results with interpretation"
13. Assessment (required, text) -- description: "Clinical impression and problem list"
14. Plan (required, text) -- description: "Treatment plan, orders, consultations, and follow-up"

**Create `src/skills/chart-skill/templates/progress-note.ts`:**

Export `progressNoteTemplate: ChartTemplate` with `templateId: 'progress-note'`, `name: 'Progress Note'`, `version: '1.0.0'`, and 6 SOAP sections:

1. Date/Time (required, text)
2. Subjective (required, text) -- description: "Patient-reported symptoms, concerns, and interval history"
3. Objective (required, text) -- description: "Vital signs, examination findings, laboratory results, imaging"
4. Neurological Status (required, text) -- description: "Focused neurological examination and status changes (neurosurgery-specific)"
5. Assessment (required, text) -- description: "Clinical impression, problem list, and clinical reasoning"
6. Plan (required, text) -- description: "Orders, interventions, medications, disposition, and follow-up"

**Create `src/skills/chart-skill/voice-adapter.ts`:**

Import `ClinicalVoice` type from `../../activation/cans-schema.js`.

Export two functions:

1. `extractVoiceDirectives(voice?: ClinicalVoice): VoiceDirectives` -- if voice is undefined/null, return empty object. Otherwise map: `tone` -> `tone`, `documentation_style` -> `documentationStyle`, `eponyms` -> `useEponyms`, `abbreviations` -> `abbreviationStyle`. Only include defined fields.

2. `buildVoiceInstructions(directives: VoiceDirectives): string` -- build a multi-line instruction string for the LLM:
   - If tone: "Write in a {tone} tone."
   - If documentationStyle: "Use {documentationStyle} documentation style."
   - If useEponyms is true: "Use standard medical eponyms (e.g., Babinski sign, Kernohan notch phenomenon)."
   - If useEponyms is false: "Avoid eponyms; use descriptive terminology."
   - If abbreviationStyle: "Abbreviation style: {abbreviationStyle}."
   - Always append: "Voice preferences affect language style only. All required clinical content must be present regardless of voice settings."
   - Join with newlines. Return empty string if no directives and only the safety line.

Import `VoiceDirectives` from `../types.js`.
  </action>
  <verify>npx vitest run test/unit/skills/chart-skill.test.ts --reporter=verbose</verify>
  <done>Three clinical note templates with correct section counts, voice adapter extracts and builds LLM instructions</done>
</task>

<task type="auto">
  <name>Task 2: Chart-skill index, SKILL.md, manifest, and tests</name>
  <files>src/skills/chart-skill/index.ts, skills/chart-skill/SKILL.md, skills/chart-skill/skill-manifest.json, test/unit/skills/chart-skill.test.ts</files>
  <action>
**Create `src/skills/chart-skill/index.ts`:**

Import all three templates and the voice adapter. Export:

- `CHART_SKILL_ID = 'chart-skill'` (const)
- `getTemplate(templateId: string): ChartTemplate | undefined` -- lookup by templateId from a `Record<string, ChartTemplate>` registry
- `getAllTemplates(): ChartTemplate[]` -- returns array of all three templates
- `buildChartSkillInstructions(voice?: ClinicalVoice): string` -- generates the complete instruction text that would be appended to SKILL.md dynamically. Calls `extractVoiceDirectives` and `buildVoiceInstructions`, and lists all available templates with their sections. This is used at runtime to customize the SKILL.md with provider-specific voice directives.

Import `ClinicalVoice` from `../../activation/cans-schema.js`.

**Create `skills/chart-skill/SKILL.md`:**

This is the OpenClaw skill file. It contains YAML frontmatter (OpenClaw format) and markdown instructions for the LLM.

```markdown
---
name: chart-skill
description: Generate template-constrained clinical documentation
author: CareAgent
version: 1.0.0
---

# Clinical Documentation Generator

You are a clinical documentation assistant. You generate structured clinical notes using predefined templates. You do NOT generate freeform clinical notes.

## Available Templates

### Operative Note
Generate a structured operative note with the following required sections:
- Date of Procedure
- Preoperative Diagnosis
- Postoperative Diagnosis
- Procedure Performed
- Surgeon
- Anesthesia
- Indications
- Description of Procedure
- Findings
- Estimated Blood Loss
- Complications
- Disposition

Optional sections (include when applicable):
- Assistant(s)
- Specimens
- Implants/Hardware
- Fluids/Drains
- Neuromonitoring

### History and Physical (H&P)
Generate a structured H&P with the following required sections:
- Chief Complaint
- History of Present Illness
- Past Medical History
- Past Surgical History
- Medications
- Allergies
- Review of Systems
- Physical Examination
- Neurological Examination
- Imaging/Studies
- Assessment
- Plan

Optional sections (include when applicable):
- Family History
- Social History

### Progress Note (SOAP)
Generate a structured progress note with ALL of the following sections:
- Date/Time
- Subjective
- Objective
- Neurological Status
- Assessment
- Plan

## Rules

1. **ALL required sections must be present.** Do not skip, merge, or reorder required sections.
2. **Use section headers exactly as listed.** Format each section with a markdown heading (##) followed by the content.
3. **Mark empty optional sections as "N/A"** rather than omitting them if the provider mentions them.
4. **Never fabricate clinical data.** If information is not provided, note it as "[Not provided - requires completion]".
5. **Neurosurgery-specific sections are required** for this provider's specialty -- do not skip Neurological Examination, Neurological Status, Neuromonitoring, or Implants/Hardware when applicable.
```

**Create `skills/chart-skill/skill-manifest.json`:**

```json
{
  "skill_id": "chart-skill",
  "version": "1.0.0",
  "requires": {
    "license": ["MD", "DO"],
    "specialty": [],
    "privilege": []
  },
  "files": {
    "SKILL.md": ""
  },
  "pinned": true,
  "approved_version": "1.0.0"
}
```

The `files.SKILL.md` hash value will be empty initially. After writing SKILL.md, compute its SHA-256 hash and update the manifest. Use a build step in the test or do it manually: read SKILL.md, compute hash with `node:crypto`, write back to manifest. Actually -- the correct approach is: after writing both files, run `computeSkillFileHash` from `src/skills/integrity.ts` on `skills/chart-skill/SKILL.md` and update the manifest's hash field. Do this as part of this task by:

1. Write SKILL.md first
2. Write manifest with placeholder hash
3. In the test file, add a test that verifies the manifest hash matches the actual SKILL.md hash
4. Compute the real hash and update the manifest file

Alternatively, since this is a build artifact issue: write a helper script or just compute the hash inline and hardcode it in the manifest. The simplest approach: use Node.js crypto in the test to compute the expected hash, then assert the manifest has it. If the manifest has a wrong hash, the test will tell you exactly what it should be. Then fix the manifest.

**Create `test/unit/skills/chart-skill.test.ts`:**

Test cases:

**Templates:**
- operativeNoteTemplate has templateId 'operative-note' and 17 sections
- operativeNoteTemplate has all required sections marked required: true
- operativeNoteTemplate neurosurgery-specific sections exist (Implants/Hardware, Fluids/Drains, Neuromonitoring)
- hAndPTemplate has templateId 'h-and-p' and 14 sections
- hAndPTemplate includes Neurological Examination (required)
- progressNoteTemplate has templateId 'progress-note' and 6 sections
- progressNoteTemplate includes Neurological Status (required)

**Index:**
- getTemplate('operative-note') returns operativeNoteTemplate
- getTemplate('h-and-p') returns hAndPTemplate
- getTemplate('progress-note') returns progressNoteTemplate
- getTemplate('unknown') returns undefined
- getAllTemplates() returns array of 3 templates

**Voice adapter:**
- extractVoiceDirectives with undefined returns empty object
- extractVoiceDirectives with full voice returns all directives
- extractVoiceDirectives with partial voice returns only defined directives
- buildVoiceInstructions with empty directives returns safety line only
- buildVoiceInstructions with tone includes tone instruction
- buildVoiceInstructions with useEponyms=true includes eponym instruction
- buildVoiceInstructions with useEponyms=false includes anti-eponym instruction
- buildVoiceInstructions always includes safety line about content completeness

**Manifest integrity:**
- Read skills/chart-skill/skill-manifest.json -- valid JSON
- Read skills/chart-skill/SKILL.md -- exists
- skill-manifest.json SKILL.md hash matches actual file hash (import computeSkillFileHash from src/skills/integrity.ts and verify)
  </action>
  <verify>npx vitest run test/unit/skills/chart-skill.test.ts --reporter=verbose</verify>
  <done>Complete chart-skill with templates, voice adapter, SKILL.md, and verified manifest</done>
</task>

</tasks>

<verification>
- `npx vitest run test/unit/skills/` passes all tests
- `npx vitest run` still passes all existing tests
- `npm run build` succeeds
- `skills/chart-skill/SKILL.md` exists with complete LLM instructions
- `skills/chart-skill/skill-manifest.json` exists with correct SKILL.md hash
</verification>

<success_criteria>
- Three templates with correct section counts (17 operative, 14 H&P, 6 progress)
- All neurosurgery-specific sections present in their respective templates
- Voice adapter handles all ClinicalVoice fields and always includes safety line
- SKILL.md provides complete, template-constrained LLM instructions
- skill-manifest.json has correct SKILL.md hash verified by tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-clinical-skills/04-03-SUMMARY.md`
</output>
