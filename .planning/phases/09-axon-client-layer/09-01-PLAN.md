---
phase: 09-axon-client-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/axon/types.ts
  - src/axon/client.ts
  - src/axon/index.ts
  - src/entry/core.ts
autonomous: true
requirements:
  - AXON-01
  - AXON-02
  - AXON-04

must_haves:
  truths:
    - "createAxonClient(config) returns an AxonClient instance with getProviderTypes() and getQuestionnaire(typeId) methods"
    - "getProviderTypes() fetches GET /v1/taxonomy/provider-types from Axon server and returns typed ProviderType[] array"
    - "getQuestionnaire(typeId) fetches GET /v1/questionnaires/:typeId from Axon server and returns typed Questionnaire object"
    - "When Axon server is unreachable (ECONNREFUSED, timeout), client throws AxonClientError with code 'CONNECTION_FAILED' and does not crash"
    - "When Axon returns non-200 HTTP status, client throws AxonClientError with code 'HTTP_ERROR' including status code and body"
    - "When Axon returns invalid JSON, client throws AxonClientError with code 'INVALID_RESPONSE'"
  artifacts:
    - path: "src/axon/types.ts"
      provides: "AxonClient interface, AxonClientConfig, AxonProviderType, AxonQuestionnaire response types, AxonClientError class"
      min_lines: 60
    - path: "src/axon/client.ts"
      provides: "createAxonClient factory function implementing AxonClient via HTTP fetch"
      exports: ["createAxonClient"]
      min_lines: 80
    - path: "src/axon/index.ts"
      provides: "Barrel re-exports for axon module"
      exports: ["createAxonClient", "AxonClient", "AxonClientConfig", "AxonClientError"]
  key_links:
    - from: "src/axon/client.ts"
      to: "Axon HTTP server"
      via: "native fetch() to /v1/taxonomy/provider-types and /v1/questionnaires/:typeId"
      pattern: "fetch\\(.*/v1/"
    - from: "src/entry/core.ts"
      to: "src/axon/index.ts"
      via: "re-export of axon public API"
      pattern: "from.*axon"
---

<objective>
Create the Axon client module for provider-core — a typed HTTP client that fetches provider type taxonomy and questionnaires from an Axon server at runtime.

Purpose: Provider-core needs to consume Axon's taxonomy (49 provider types) and questionnaire data without bundling Axon's data files. This client establishes the HTTP integration boundary between provider-core and Axon, with structured error handling for network failures, HTTP errors, and invalid responses.

Output: `src/axon/` module with AxonClient interface, createAxonClient factory, types, and barrel file; public API wired into core.ts re-exports.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Axon server API surface (HTTP endpoints provider-core will call):
# - GET /v1/taxonomy/provider-types -> { provider_types: ProviderType[] }
# - GET /v1/questionnaires/:typeId -> Questionnaire
# - GET /health -> { status, version, uptime }
#
# Axon types (from @careagent/axon/types — reference only, do NOT import):
# - ProviderType: { id: string, display_name: string, category: string, member_roles: string[] }
# - Questionnaire: { provider_type: string, version: string, taxonomy_version: string, display_name: string, description: string, questions: Question[] }
# - Question: { id: string, text: string, answer_type: 'boolean' | 'single_select', required: boolean, options?: QuestionOption[], show_when?: QuestionCondition, cans_field: string, action_assignments?: ActionAssignment[] }
# - QuestionOption: { value: string, label: string, description?: string }
# - QuestionCondition: { question_id: string, equals: string }
# - ActionAssignment: { answer_value: string, grants: string[] }

@src/entry/core.ts
@src/adapters/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define AxonClient types and error class</name>
  <files>src/axon/types.ts</files>
  <action>
Create `src/axon/types.ts` with:

1. **AxonClientConfig interface:**
   - `baseUrl: string` — Axon server base URL (e.g., 'http://localhost:9999')
   - `timeoutMs?: number` — request timeout in milliseconds (default: 5000)

2. **Response types (locally defined, do NOT import from @careagent/axon):**
   - `AxonProviderType` — `{ id: string, display_name: string, category: string, member_roles: string[] }`
   - `AxonQuestionnaire` — `{ provider_type: string, version: string, taxonomy_version: string, display_name: string, description: string, questions: AxonQuestion[] }`
   - `AxonQuestion` — `{ id: string, text: string, answer_type: 'boolean' | 'single_select', required: boolean, options?: AxonQuestionOption[], show_when?: AxonQuestionCondition, cans_field: string, action_assignments?: AxonActionAssignment[] }`
   - `AxonQuestionOption` — `{ value: string, label: string, description?: string }`
   - `AxonQuestionCondition` — `{ question_id: string, equals: string }`
   - `AxonActionAssignment` — `{ answer_value: string, grants: string[] }`

3. **AxonClientError class extending Error:**
   - `code: 'CONNECTION_FAILED' | 'HTTP_ERROR' | 'INVALID_RESPONSE' | 'TIMEOUT'`
   - `statusCode?: number` (for HTTP errors)
   - `cause?: unknown` (original error)
   - Constructor: `(message: string, code: AxonClientErrorCode, options?: { statusCode?: number, cause?: unknown })`

4. **AxonClient interface:**
   - `getProviderTypes(): Promise<AxonProviderType[]>` — fetches full taxonomy provider type list
   - `getQuestionnaire(providerTypeId: string): Promise<AxonQuestionnaire>` — fetches questionnaire for a specific provider type
   - `checkHealth(): Promise<{ status: string, version: string }>` — health check for connection verification

Follow project conventions:
- Types as PascalCase interfaces
- Module-level JSDoc block explaining purpose
- `AxonClientErrorCode` type alias for the error code union
- Export all types and the error class
  </action>
  <verify>Run `npx tsc --noEmit` — no new type errors in src/axon/types.ts</verify>
  <done>AxonClient interface, all response types, AxonClientConfig, and AxonClientError class exist in src/axon/types.ts with proper JSDoc documentation</done>
</task>

<task type="auto">
  <name>Task 2: Implement createAxonClient HTTP factory</name>
  <files>src/axon/client.ts</files>
  <action>
Create `src/axon/client.ts` implementing the AxonClient interface with native `fetch()`:

1. **createAxonClient(config: AxonClientConfig): AxonClient factory:**
   - Store `baseUrl` (strip trailing slash) and `timeoutMs` (default 5000) from config
   - Return object implementing AxonClient interface

2. **Internal helper `fetchJson<T>(path: string): Promise<T>`:**
   - Build full URL: `${baseUrl}${path}`
   - Use `AbortController` with `setTimeout` for timeout handling
   - Call `fetch(url, { signal, headers: { 'Accept': 'application/json' } })`
   - On fetch error: check if `err.name === 'AbortError'` -> throw AxonClientError with code 'TIMEOUT'; otherwise throw with code 'CONNECTION_FAILED'
   - On non-2xx response: read `response.text()`, throw AxonClientError with code 'HTTP_ERROR', include statusCode and body in message
   - Parse response as JSON: `response.json()` — on parse failure throw AxonClientError with code 'INVALID_RESPONSE'
   - Always clear the AbortController timeout in a `finally` block
   - Return parsed JSON cast to T

3. **getProviderTypes():**
   - Call `fetchJson<{ provider_types: AxonProviderType[] }>('/v1/taxonomy/provider-types')`
   - Return `result.provider_types`

4. **getQuestionnaire(providerTypeId):**
   - Validate providerTypeId is non-empty string; throw AxonClientError('INVALID_RESPONSE') if empty
   - Call `fetchJson<AxonQuestionnaire>('/v1/questionnaires/' + encodeURIComponent(providerTypeId))`
   - Return result directly

5. **checkHealth():**
   - Call `fetchJson<{ status: string, version: string }>('/health')`
   - Return result

Use `const LAYER_NAME = 'axon-client'` convention for module identification.
Use `err instanceof Error ? err.message : String(err)` pattern for unknown errors.
Do NOT import from `@careagent/axon` — all types are locally defined in types.ts.
Import types from `./types.js` (ESM .js extension convention).
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Run `pnpm test` — existing tests still pass (no regressions).</verify>
  <done>createAxonClient factory exists, implements all three AxonClient methods via HTTP fetch, handles all four error codes (CONNECTION_FAILED, HTTP_ERROR, INVALID_RESPONSE, TIMEOUT), uses AbortController for timeouts</done>
</task>

<task type="auto">
  <name>Task 3: Create barrel file and wire into core.ts</name>
  <files>src/axon/index.ts, src/entry/core.ts</files>
  <action>
1. **Create `src/axon/index.ts`:**
   - Re-export the factory: `export { createAxonClient } from './client.js'`
   - Re-export types: `export type { AxonClient, AxonClientConfig, AxonProviderType, AxonQuestionnaire, AxonQuestion, AxonQuestionOption, AxonQuestionCondition, AxonActionAssignment, AxonClientErrorCode } from './types.js'`
   - Re-export error class: `export { AxonClientError } from './types.js'`

2. **Update `src/entry/core.ts`:**
   - Add axon re-exports at the end (following existing pattern of domain-level re-exports):
     ```
     // Axon client
     export { createAxonClient, AxonClientError } from '../axon/index.js'
     export type { AxonClient, AxonClientConfig, AxonProviderType, AxonQuestionnaire, AxonQuestion, AxonQuestionOption, AxonQuestionCondition, AxonActionAssignment, AxonClientErrorCode } from '../axon/index.js'
     ```

Follow existing barrel/re-export patterns in the codebase (see src/hardening/index.ts, src/refinement/index.ts for examples).
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Run `pnpm test` — all existing tests pass. Verify `src/axon/index.ts` exports resolve correctly.</verify>
  <done>Barrel file exports all public API. core.ts re-exports axon module types and factory. Full Axon client API surface accessible via `@careagent/provider-core/core` import path.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero new errors
2. `pnpm test` passes — no regressions to existing 714+ tests
3. `src/axon/types.ts` contains AxonClient interface with three methods
4. `src/axon/client.ts` contains createAxonClient factory using native fetch()
5. `src/axon/index.ts` barrel re-exports all public types and factory
6. `src/entry/core.ts` re-exports axon module
7. AxonClientError class has four error codes: CONNECTION_FAILED, HTTP_ERROR, INVALID_RESPONSE, TIMEOUT
</verification>

<success_criteria>
- AxonClient interface and createAxonClient factory exist and type-check
- All Axon response types are locally defined (no @careagent/axon import dependency)
- Error handling covers all four failure modes with structured AxonClientError
- Public API accessible via core.ts re-exports
- Zero regression to existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/09-axon-client-layer/09-01-SUMMARY.md`
</output>
