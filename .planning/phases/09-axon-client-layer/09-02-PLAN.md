---
phase: 09-axon-client-layer
plan: 02
type: execute
wave: 2
depends_on:
  - "09-01"
files_modified:
  - test/unit/axon/client.test.ts
  - test/integration/axon.test.ts
autonomous: true
requirements:
  - AXON-01
  - AXON-02
  - AXON-04

must_haves:
  truths:
    - "Unit tests verify getProviderTypes() parses correct response and returns AxonProviderType[] array"
    - "Unit tests verify getQuestionnaire(typeId) parses correct response and returns AxonQuestionnaire"
    - "Unit tests verify CONNECTION_FAILED error when fetch rejects (network error)"
    - "Unit tests verify TIMEOUT error when request exceeds timeoutMs"
    - "Unit tests verify HTTP_ERROR with statusCode when server returns non-2xx"
    - "Unit tests verify INVALID_RESPONSE when server returns non-JSON body"
    - "Integration tests prove provider-core retrieves 49 provider types from a live Axon mock server"
    - "Integration tests prove provider-core retrieves physician questionnaire with 13 questions from Axon mock server"
    - "Integration tests prove graceful error when Axon mock server is stopped (unreachable)"
  artifacts:
    - path: "test/unit/axon/client.test.ts"
      provides: "Unit tests for createAxonClient with mocked fetch"
      min_lines: 120
    - path: "test/integration/axon.test.ts"
      provides: "Integration tests using @careagent/axon/mock server"
      min_lines: 80
  key_links:
    - from: "test/unit/axon/client.test.ts"
      to: "src/axon/client.ts"
      via: "imports createAxonClient and AxonClientError"
      pattern: "import.*createAxonClient"
    - from: "test/integration/axon.test.ts"
      to: "@careagent/axon/mock"
      via: "imports createMockAxonServer for live HTTP testing"
      pattern: "import.*createMockAxonServer"
---

<objective>
Create comprehensive unit and integration tests for the Axon client, proving all three Phase 9 requirements (AXON-01, AXON-02, AXON-04) are satisfied.

Purpose: Verify the Axon client correctly fetches taxonomy data and questionnaires from an Axon server, handles all error modes gracefully, and integrates with a real Axon mock server instance.

Output: Unit tests with mocked fetch covering happy paths and all error codes; integration tests using `@careagent/axon/mock` proving end-to-end HTTP communication with live server.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-axon-client-layer/09-01-SUMMARY.md

# Axon mock server: @careagent/axon/mock exports createMockAxonServer()
# Mock server provides:
#   GET /v1/taxonomy/actions?type=... (existing)
#   GET /v1/questionnaires/:typeId (existing)
#   GET /health (existing in production server)
#
# NOTE: The mock server does NOT have GET /v1/taxonomy/provider-types.
# The integration test needs to handle this — either:
# (a) The Axon mock server gets a provider-types endpoint added (check at execution time)
# (b) Test verifies against a local HTTP server that implements the endpoint
# (c) Unit tests cover this path with mocked fetch; integration tests skip this specific endpoint
#
# @careagent/axon must be added as a devDependency for test access to mock server and types.

@src/axon/types.ts
@src/axon/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add @careagent/axon devDependency and create unit tests</name>
  <files>test/unit/axon/client.test.ts</files>
  <action>
1. **Add @careagent/axon as a devDependency:**
   - Run `pnpm add -D @careagent/axon@link:/Users/medomatic/Documents/Projects/axon` (link to local repo for development)
   - This gives test access to mock server and type definitions

2. **Create `test/unit/axon/client.test.ts`:**

Use `vi.stubGlobal('fetch', mockFetch)` to mock the native fetch API. Follow existing test patterns (describe/it structure, beforeEach/afterEach cleanup).

Test suites:

**describe('createAxonClient'):**
- `it('returns an object with getProviderTypes, getQuestionnaire, and checkHealth methods')`

**describe('getProviderTypes'):**
- `it('fetches GET /v1/taxonomy/provider-types and returns provider type array')` — mock fetch returning `{ provider_types: [{ id: 'physician', display_name: 'Physician', category: 'medical', member_roles: ['MD', 'DO'] }] }`, assert returns the array
- `it('sends Accept: application/json header')` — assert fetch was called with correct headers
- `it('constructs correct URL from baseUrl config')` — test with baseUrl 'http://axon:9999', assert fetch called with 'http://axon:9999/v1/taxonomy/provider-types'
- `it('strips trailing slash from baseUrl')` — config with 'http://axon:9999/', assert no double slash

**describe('getQuestionnaire'):**
- `it('fetches GET /v1/questionnaires/:typeId and returns questionnaire')` — mock fetch returning full questionnaire object
- `it('URL-encodes the providerTypeId')` — pass 'advanced_practice_provider', assert correct URL
- `it('throws AxonClientError with HTTP_ERROR when server returns 404')` — mock 404 response, assert error.code === 'HTTP_ERROR' and error.statusCode === 404

**describe('checkHealth'):**
- `it('fetches GET /health and returns status object')` — mock success response

**describe('error handling'):**
- `it('throws AxonClientError with CONNECTION_FAILED when fetch rejects with TypeError')` — mock fetch rejecting with TypeError('fetch failed'), assert error.code === 'CONNECTION_FAILED'
- `it('throws AxonClientError with TIMEOUT when request exceeds timeoutMs')` — create client with timeoutMs: 50, mock fetch that never resolves (use vi.fn returning new Promise that hangs), assert error.code === 'TIMEOUT'. Use `vi.useFakeTimers()` and `vi.advanceTimersByTime(60)` to trigger the abort.
- `it('throws AxonClientError with HTTP_ERROR on 500 status')` — mock 500 response with JSON body, assert error.code === 'HTTP_ERROR' and error.statusCode === 500
- `it('throws AxonClientError with INVALID_RESPONSE on non-JSON body')` — mock 200 response with text/html body that fails JSON parse, assert error.code === 'INVALID_RESPONSE'
- `it('includes original error as cause')` — assert error.cause is defined on CONNECTION_FAILED errors
- `it('defaults timeoutMs to 5000 when not specified')` — assert AbortController timeout set to 5000

Helper factory at top of file:
```typescript
function createMockResponse(body: unknown, init?: ResponseInit): Response {
  return new Response(JSON.stringify(body), {
    status: init?.status ?? 200,
    headers: { 'Content-Type': 'application/json', ...init?.headers },
  });
}
```

Restore global fetch in afterEach: `vi.restoreAllMocks()`
  </action>
  <verify>Run `pnpm test test/unit/axon/client.test.ts` — all tests pass. Run `pnpm test` — full suite passes with no regressions.</verify>
  <done>Unit tests cover all three AxonClient methods (getProviderTypes, getQuestionnaire, checkHealth) and all four error codes (CONNECTION_FAILED, TIMEOUT, HTTP_ERROR, INVALID_RESPONSE) with mocked fetch</done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests with Axon mock server</name>
  <files>test/integration/axon.test.ts</files>
  <action>
Create `test/integration/axon.test.ts` that tests the Axon client against a live Axon mock server from `@careagent/axon/mock`.

**IMPORTANT:** The Axon mock server may not have a `GET /v1/taxonomy/provider-types` endpoint. At execution time:
1. Check if `createMockAxonServer` from `@careagent/axon/mock` serves provider-types
2. If it does, test against it directly
3. If it does NOT, create a lightweight wrapper HTTP server that adds the provider-types endpoint by importing `AxonTaxonomy.getProviderTypes()` from `@careagent/axon` and serving it alongside the mock server. Alternatively, create a small `node:http` server that wraps the mock server and adds the missing endpoint.

Test structure:

```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest'
import { createMockAxonServer } from '@careagent/axon/mock'
import { createAxonClient } from '../../src/axon/client.js'
import type { AxonClient } from '../../src/axon/types.js'
```

**Setup/teardown:**
- `beforeAll`: start mock server, create axon client pointing at its URL
- `afterAll`: stop mock server

**describe('Axon client integration — AXON-01: Provider type list'):**
- `it('retrieves provider types from Axon server')` — call `client.getProviderTypes()`, assert result is an array with 49 entries
- `it('each provider type has id, display_name, and category')` — assert first few entries match expected shape
- `it('includes physician type with MD/DO roles')` — find physician entry, assert fields

**describe('Axon client integration — AXON-02: Questionnaire fetch'):**
- `it('retrieves physician questionnaire')` — call `client.getQuestionnaire('physician')`, assert provider_type === 'physician' and questions.length === 13
- `it('questionnaire contains questions with expected fields')` — assert first question has id, text, answer_type, required, cans_field
- `it('returns AxonClientError for unknown provider type')` — call with 'nonexistent_type', expect AxonClientError with code 'HTTP_ERROR' and statusCode 404

**describe('Axon client integration — AXON-04: Graceful error handling'):**
- `it('throws CONNECTION_FAILED when server is stopped')` — stop the mock server, create client with the old URL, call getProviderTypes(), assert AxonClientError with code 'CONNECTION_FAILED'. Then restart the server for other tests (or use a separate client pointing to a dead port).
- `it('includes helpful error message with server URL')` — assert error.message contains the base URL
- `it('health check returns server status')` — call `client.checkHealth()`, assert status === 'ok'

Use the `AxonClientError` import to assert error types: `expect(error).toBeInstanceOf(AxonClientError)`.

Note: If the mock server doesn't serve `/v1/taxonomy/provider-types`, the AXON-01 integration tests should either:
- Extend the mock server with a proxy, OR
- Use a simple `node:http` server that imports AxonTaxonomy and serves provider types, then proxies other requests to the mock server
Document which approach was used in the test file comments.
  </action>
  <verify>Run `pnpm test test/integration/axon.test.ts` — all integration tests pass. Run `pnpm test` — full suite passes. Run `pnpm test:coverage` — axon client coverage meets 80% threshold.</verify>
  <done>Integration tests prove all three Phase 9 requirements: AXON-01 (49 provider types retrieved), AXON-02 (physician questionnaire with 13 questions retrieved), AXON-04 (graceful AxonClientError when server unreachable). Coverage meets 80% threshold.</done>
</task>

</tasks>

<verification>
1. `pnpm test` — full suite passes including new axon tests
2. `pnpm test:coverage` — src/axon/ module meets 80% line/branch/function/statement coverage
3. AXON-01 proven: integration test retrieves 49 provider types with correct shape
4. AXON-02 proven: integration test retrieves physician questionnaire with 13 questions
5. AXON-04 proven: integration test shows CONNECTION_FAILED error on unreachable server
6. Unit tests cover all four AxonClientError codes
7. No regressions to existing test suite
</verification>

<success_criteria>
- All unit tests pass with mocked fetch
- All integration tests pass against live Axon mock server
- Coverage >= 80% on all metrics for src/axon/
- Three Phase 9 requirements (AXON-01, AXON-02, AXON-04) verified by tests
- @careagent/axon devDependency added for test access
- Zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/09-axon-client-layer/09-02-SUMMARY.md`
</output>
