---
phase: 10-questionnaire-execution-engine
plan: 03
type: execute
wave: 3
depends_on:
  - "10-02"
files_modified:
  - test/unit/onboarding/questionnaire-stage.test.ts
  - test/unit/onboarding/engine.test.ts
  - test/unit/onboarding/stages.test.ts
  - test/integration/onboarding.test.ts
autonomous: true
requirements:
  - ONBD-01
  - ONBD-02
  - ONBD-03
  - ONBD-04
  - ONBD-05
  - ONBD-06
  - ONBD-07

must_haves:
  truths:
    - "Tests prove onboarding asks provider name as first question"
    - "Tests prove provider type selection from Axon's 49 categories"
    - "Tests prove questionnaire is fetched from Axon after type selection"
    - "Tests prove boolean and single_select questions are presented dynamically"
    - "Tests prove show_when conditions filter questions correctly"
    - "Tests prove action assignments accumulate granted actions"
    - "Tests prove stub questionnaire blocks onboarding with helpful message"
  artifacts:
    - path: "test/unit/onboarding/questionnaire-stage.test.ts"
      provides: "Unit tests for interactive questionnaire execution"
      min_lines: 80
    - path: "test/unit/onboarding/engine.test.ts"
      provides: "Updated engine tests for v2.0 flow with AxonClient"
      min_lines: 100
    - path: "test/integration/onboarding.test.ts"
      provides: "Integration tests proving all ONBD requirements"
      min_lines: 80
  key_links:
    - from: "test/unit/onboarding/questionnaire-stage.test.ts"
      to: "src/onboarding/questionnaire-stage.ts"
      via: "imports runQuestionnaire"
      pattern: "import.*runQuestionnaire"
    - from: "test/integration/onboarding.test.ts"
      to: "src/onboarding/engine.ts"
      via: "imports runInterview with mock AxonClient"
      pattern: "runInterview"
---

<objective>
Write comprehensive tests proving all seven ONBD requirements are satisfied by the v2.0 onboarding flow.

Purpose: These tests serve as the verification layer for Phase 10 — each ONBD requirement is proven by at least one test case. Unit tests verify individual components; integration tests verify the full flow end-to-end.

Output: Updated and new test files covering questionnaire-stage, engine v2.0 flow, and full integration.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-questionnaire-execution-engine/10-01-SUMMARY.md
@.planning/phases/10-questionnaire-execution-engine/10-02-SUMMARY.md

@src/onboarding/engine.ts
@src/onboarding/stages.ts
@src/onboarding/questionnaire-stage.ts
@src/onboarding/questionnaire-runner.ts
@src/axon/types.ts
@src/cli/io.ts
@test/unit/onboarding/engine.test.ts
@test/integration/onboarding.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for questionnaire-stage.ts and updated stages.ts</name>
  <files>
    test/unit/onboarding/questionnaire-stage.test.ts
    test/unit/onboarding/stages.test.ts
  </files>
  <action>
**Create `test/unit/onboarding/questionnaire-stage.test.ts`:**

Test `runQuestionnaire` using `createMockIO` from `src/cli/io.ts`:

1. **Boolean question** — Mock IO returns 'y' for confirm. Verify answer recorded as `'yes'` and returned in answers map.
2. **Boolean question — no** — Mock IO returns 'n' for confirm. Verify answer recorded as `'no'`.
3. **Single select question** — Mock IO returns index 0 for select. Verify answer recorded as `options[0].value`.
4. **show_when skip** — Two questions: Q1 (boolean, no condition), Q2 (single_select, show_when: { question_id: 'q1', equals: 'yes' }). Mock IO answers Q1 with 'n'. Verify Q2 is skipped (not in answers, io.select not called for Q2).
5. **show_when include** — Same setup but Q1 answered 'y'. Verify Q2 IS presented.
6. **Action assignments** — Question with action_assignments: `[{ answer_value: 'yes', grants: ['prescribe_medication', 'order_lab'] }]`. Answer 'yes'. Verify grantedActions contains both action IDs.
7. **Mixed questions flow** — 3 questions with mixed types and conditions. Verify full answers map and grantedActions array.

**Update `test/unit/onboarding/stages.test.ts`:**

The existing test file tests v1.0 stages. Add new tests for v2.0 stages:

1. **identityStage v2.0** — Verify it asks ONLY for name (no NPI question), advances to PROVIDER_TYPE stage
2. **providerTypeStage** — Provide mock providerTypes in state, mock IO selects index 1. Verify selectedProviderTypeId and selectedProviderTypeDisplayName are set in returned state. Verify stage advances to QUESTIONNAIRE.
3. **Keep existing v1.0 stage tests passing** — The old stages still exist in the file, their tests should still pass.

Use `createMockIO` for all tests. Build AxonProviderType fixtures with realistic data:
```typescript
const mockProviderTypes: AxonProviderType[] = [
  { id: 'physician', display_name: 'Physician', category: 'Independent Practitioners', member_roles: [] },
  { id: 'nurse_practitioner', display_name: 'Nurse Practitioner', category: 'Advanced Practice Providers', member_roles: [] },
];
```
  </action>
  <verify>`pnpm vitest run test/unit/onboarding/questionnaire-stage.test.ts test/unit/onboarding/stages.test.ts` — all tests pass.</verify>
  <done>Unit tests verify runQuestionnaire handles boolean, single_select, show_when, and action_assignments. Updated stages tests verify v2.0 identity and provider type stages.</done>
</task>

<task type="auto">
  <name>Task 2: Engine and integration tests proving ONBD-01 through ONBD-07</name>
  <files>
    test/unit/onboarding/engine.test.ts
    test/integration/onboarding.test.ts
  </files>
  <action>
**Update `test/unit/onboarding/engine.test.ts`:**

The existing engine tests test the v1.0 `runInterview(io)` flow. They need to be updated for the v2.0 `runInterview(io, axonClient)` signature. Create a mock AxonClient:

```typescript
function createMockAxonClient(options?: {
  providerTypes?: AxonProviderType[];
  questionnaire?: AxonQuestionnaire;
}): AxonClient {
  return {
    async getProviderTypes() {
      return options?.providerTypes ?? [
        { id: 'physician', display_name: 'Physician', category: 'Independent Practitioners', member_roles: [] },
      ];
    },
    async getQuestionnaire(id: string) {
      return options?.questionnaire ?? {
        provider_type: id,
        version: '1.0',
        taxonomy_version: '1.0',
        display_name: 'Physician',
        description: 'Test questionnaire',
        questions: [],
      };
    },
    async checkHealth() {
      return { status: 'ok', version: '1.0' };
    },
  };
}
```

Test cases:
1. **ONBD-01: Name first** — Run full interview with mock IO. Verify the first question after welcome is the name question.
2. **ONBD-02: Provider type selection** — Verify the provider type selection stage presents Axon types and records selection.
3. **ONBD-03: Questionnaire fetch** — Verify getQuestionnaire is called with the selected provider type ID.
4. **v2.0 flow completes** — Mock IO answers all questions. Verify InterviewResult has correct data including grantedActions.

**Update `test/integration/onboarding.test.ts`:**

This is the end-to-end integration test. It should run the full `runInitCommand` with a mock AxonClient and mock IO:

1. **ONBD-01 + ONBD-02: Name and type** — Full flow: welcome -> name -> type selection -> questionnaire -> remaining stages -> review -> approve. Verify CANS.md is written with correct provider name and type.

2. **ONBD-04 + ONBD-05: Dynamic questions with conditions** — Use a questionnaire with:
   - Q1: boolean "Do you prescribe controlled substances?" (no condition)
   - Q2: single_select "Select your DEA schedule" with show_when: { question_id: 'q1', equals: 'yes' }
   Mock IO answers Q1 'yes', Q2 selects option. Verify both answers recorded.

3. **ONBD-06: Action assignments** — Use a questionnaire where Q1 has action_assignments granting 'prescribe_medication'. Verify result.grantedActions includes 'prescribe_medication' and CANS.md scope.permitted_actions contains it.

4. **ONBD-07: Stub blocking** — Use mock AxonClient that returns empty questions for 'nurse_practitioner' but full questions for 'physician'. Mock IO first selects nurse_practitioner, verify blocking message is displayed, then on re-selection picks physician and flow continues. Verify io.display output contains the stub blocking message.

For integration tests that involve `reviewLoop`, mock the IO to select "Approve and save" (choice 0) in the review menu.

The mock IO response sequences for full-flow tests need to provide answers for:
- Welcome: 'y' (HIPAA acknowledge)
- Identity: 'Dr. Jane Smith' (name)
- Provider Type: select index (e.g., 0 for Physician)
- Questionnaire questions: answers for each visible question
- Philosophy: 'Evidence-based medicine...'
- Voice: Enter to skip each (7 skips)
- Autonomy: select for each (7 selects)
- Consent: 'y', 'y', 'y' (three confirmations)
- Review: 0 (approve)
  </action>
  <verify>
- `pnpm vitest run test/unit/onboarding/engine.test.ts` — all tests pass
- `pnpm vitest run test/integration/onboarding.test.ts` — all tests pass
- `pnpm test` — full suite passes with zero regressions
  </verify>
  <done>
- Engine tests updated for v2.0 AxonClient signature with mock client
- Integration tests prove all 7 ONBD requirements end-to-end
- Full test suite passes
  </done>
</task>

</tasks>

<verification>
- `pnpm vitest run test/unit/onboarding/` — all onboarding unit tests pass
- `pnpm vitest run test/integration/onboarding.test.ts` — integration tests pass
- `pnpm test` — full suite passes (738+ existing + new tests, zero regressions)
- Each ONBD requirement proven by at least one test:
  - ONBD-01: engine test verifying name is first question
  - ONBD-02: engine test verifying Axon type selection
  - ONBD-03: engine test verifying getQuestionnaire called after type selection
  - ONBD-04: questionnaire-stage test verifying boolean and single_select
  - ONBD-05: questionnaire-stage test verifying show_when filtering
  - ONBD-06: integration test verifying grantedActions in CANS.md
  - ONBD-07: integration test verifying stub blocking message
</verification>

<success_criteria>
- All seven ONBD requirements have dedicated test coverage
- Full test suite passes with zero regressions
- Mock AxonClient pattern established for downstream Phase 11 tests
- Integration tests prove the end-to-end flow from CLI init through CANS.md generation
</success_criteria>

<output>
After completion, create `.planning/phases/10-questionnaire-execution-engine/10-03-SUMMARY.md`
</output>
