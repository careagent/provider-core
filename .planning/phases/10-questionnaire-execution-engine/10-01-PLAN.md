---
phase: 10-questionnaire-execution-engine
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/onboarding/questionnaire-runner.ts
  - test/unit/onboarding/questionnaire-runner.test.ts
autonomous: true
requirements:
  - ONBD-04
  - ONBD-05
  - ONBD-06

must_haves:
  truths:
    - "Boolean and single_select questions produce typed answers"
    - "Questions with show_when conditions are skipped when the referenced prior answer does not match"
    - "Questions with show_when conditions are shown when the referenced prior answer matches"
    - "Action assignments accumulate granted taxonomy action IDs based on the provider's answers"
    - "Questions without action_assignments do not affect the granted actions list"
  artifacts:
    - path: "src/onboarding/questionnaire-runner.ts"
      provides: "Pure questionnaire evaluation logic"
      exports: ["evaluateShowWhen", "collectGrantedActions", "QuestionnaireAnswers"]
      min_lines: 40
    - path: "test/unit/onboarding/questionnaire-runner.test.ts"
      provides: "TDD tests for questionnaire logic"
      min_lines: 80
  key_links:
    - from: "src/onboarding/questionnaire-runner.ts"
      to: "src/axon/types.ts"
      via: "import type AxonQuestion, AxonQuestionCondition, AxonActionAssignment"
      pattern: "import.*AxonQuestion.*from.*axon"
---

<objective>
Build the pure-logic questionnaire runner that evaluates show_when conditions and accumulates action assignments from questionnaire answers.

Purpose: This is the core decision engine for Phase 10 — it determines which questions to show based on conditional logic and which taxonomy actions to grant based on answers. Separating this from I/O enables thorough TDD.

Output: `src/onboarding/questionnaire-runner.ts` with exported functions for show_when evaluation and action collection, plus comprehensive tests.
</objective>

<execution_context>
@/Users/medomatic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medomatic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-axon-client-layer/09-01-SUMMARY.md

@src/axon/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — Write failing tests for questionnaire runner</name>
  <files>test/unit/onboarding/questionnaire-runner.test.ts</files>
  <action>
Create test file with the following test cases (all importing from `../../src/onboarding/questionnaire-runner.js`):

**Type definitions to test:**
- `QuestionnaireAnswers` — a `Record<string, string>` mapping question_id to answer value

**evaluateShowWhen tests:**
1. Returns `true` when question has no `show_when` (unconditional question)
2. Returns `true` when `show_when.question_id` exists in answers AND its value `=== show_when.equals`
3. Returns `false` when `show_when.question_id` exists in answers BUT value does NOT match `show_when.equals`
4. Returns `false` when `show_when.question_id` is NOT in answers at all (referenced question not yet answered)

**collectGrantedActions tests:**
1. Returns empty array when no questions have `action_assignments`
2. Returns granted action IDs when answer matches an `action_assignment.answer_value` — e.g., question with `action_assignments: [{ answer_value: 'yes', grants: ['prescribe_medication'] }]` and answer `'yes'` yields `['prescribe_medication']`
3. Does NOT grant actions when answer does not match any `action_assignment.answer_value`
4. Accumulates actions from multiple questions — two questions each granting different actions, both answered affirmatively, yields combined action list
5. Skips questions not present in answers (unanswered questions grant nothing)
6. Deduplicates action IDs when multiple questions grant the same action

**getVisibleQuestions tests:**
1. Returns all questions when none have `show_when`
2. Filters out questions whose `show_when` condition is not met
3. Returns questions in original order

Build test fixtures using the `AxonQuestion` type from `src/axon/types.ts`. Use realistic clinical question examples (e.g., "Do you prescribe controlled substances?", "Do you perform surgical procedures?").

Run tests — they MUST fail (module does not exist yet).
  </action>
  <verify>Run `pnpm vitest run test/unit/onboarding/questionnaire-runner.test.ts` — all tests fail with import/module-not-found errors. Zero passes.</verify>
  <done>Test file exists with 13+ test cases covering evaluateShowWhen, collectGrantedActions, and getVisibleQuestions — all failing.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN — Implement questionnaire-runner.ts to pass all tests</name>
  <files>src/onboarding/questionnaire-runner.ts</files>
  <action>
Create `src/onboarding/questionnaire-runner.ts` with the following exports:

```typescript
import type { AxonQuestion, AxonQuestionCondition, AxonActionAssignment } from '../axon/types.js';

/** Maps question_id to the provider's answer value. */
export type QuestionnaireAnswers = Record<string, string>;

/**
 * Evaluate whether a question should be shown based on its show_when condition.
 * Returns true if the question has no condition, or the condition is met.
 */
export function evaluateShowWhen(
  showWhen: AxonQuestionCondition | undefined,
  answers: QuestionnaireAnswers,
): boolean
```

Logic:
- If `showWhen` is `undefined`, return `true`
- Otherwise, check if `answers[showWhen.question_id] === showWhen.equals`

```typescript
/**
 * Given a list of questions and the provider's answers, collect all
 * taxonomy action IDs granted by action_assignments.
 */
export function collectGrantedActions(
  questions: AxonQuestion[],
  answers: QuestionnaireAnswers,
): string[]
```

Logic:
- For each question that has `action_assignments` and a matching answer in `answers`:
  - Find assignments where `assignment.answer_value === answers[question.id]`
  - Collect all `grants` arrays
- Deduplicate using `[...new Set(allActions)]`
- Return the unique action IDs array

```typescript
/**
 * Filter questions to only those whose show_when condition is met
 * given the current answers. Preserves original question order.
 */
export function getVisibleQuestions(
  questions: AxonQuestion[],
  answers: QuestionnaireAnswers,
): AxonQuestion[]
```

Logic:
- Filter `questions` using `evaluateShowWhen(q.show_when, answers)` for each

Module-level JSDoc: explain this is the pure-logic questionnaire runner for ONBD-04 (question types), ONBD-05 (conditional display), ONBD-06 (action assignments).

Run tests — all MUST pass.
  </action>
  <verify>Run `pnpm vitest run test/unit/onboarding/questionnaire-runner.test.ts` — all 13+ tests pass.</verify>
  <done>questionnaire-runner.ts implements evaluateShowWhen, collectGrantedActions, and getVisibleQuestions — all tests green.</done>
</task>

</tasks>

<verification>
- `pnpm vitest run test/unit/onboarding/questionnaire-runner.test.ts` — all tests pass
- `pnpm typecheck` — no new type errors introduced
- Module exports: `evaluateShowWhen`, `collectGrantedActions`, `getVisibleQuestions`, `QuestionnaireAnswers` type
</verification>

<success_criteria>
- Pure functions correctly evaluate show_when conditions (ONBD-05)
- Action assignments are correctly collected and deduplicated (ONBD-06)
- Question filtering works with mixed conditional/unconditional questions (ONBD-04)
- All tests pass with zero regressions on existing 738 tests
</success_criteria>

<output>
After completion, create `.planning/phases/10-questionnaire-execution-engine/10-01-SUMMARY.md`
</output>
