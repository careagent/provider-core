---
phase: 02.1-architectural-alignment
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/activation/cans-schema.ts
  - test/unit/activation/cans-schema.test.ts
  - test/fixtures/valid-cans-data.ts
autonomous: true

must_haves:
  truths:
    - "CANSSchema accepts documents with the new optional neuron, skills, and cross_installation fields"
    - "CANSSchema still validates all existing CANS.md fixtures without modification"
    - "All 388 existing tests pass without any fixture changes"
    - "New schema fields use Type.Optional() at the top level"
  artifacts:
    - path: "src/activation/cans-schema.ts"
      provides: "NeuronConfigSchema, SkillGatingRuleSchema, SkillGatingSchema, CrossInstallationConsentSchema sub-schemas and expanded CANSSchema"
      contains: "NeuronConfigSchema"
    - path: "test/unit/activation/cans-schema.test.ts"
      provides: "Tests for new optional schema fields"
      contains: "neuron"
  key_links:
    - from: "src/activation/cans-schema.ts"
      to: "src/activation/cans-parser.ts"
      via: "CANSSchema import for validation"
      pattern: "CANSSchema"
    - from: "src/activation/cans-schema.ts"
      to: "test/fixtures/valid-cans-data.ts"
      via: "Test fixture must still validate"
      pattern: "valid.*cans"
---

<objective>
Expand the CANS TypeBox schema with optional fields for neuron registration, clinical skill gating, and cross-installation consent.

Purpose: The README promises neuron, skills, and cross-installation configuration in CANS.md. Adding these as optional TypeBox fields now means Phase 3+ can use them immediately without schema migration. All fields are Type.Optional() so existing CANS.md files and test fixtures remain valid.

Output: Extended CANSSchema with 3 new optional top-level fields, 3 new sub-schemas, updated TypeScript types, and comprehensive tests for the new fields.
</objective>

<execution_context>
@/Users/thomasanderson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thomasanderson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-architectural-alignment/02.1-RESEARCH.md
@src/activation/cans-schema.ts
@test/unit/activation/cans-schema.test.ts
@test/fixtures/valid-cans-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add neuron, skills, and cross_installation schemas to CANSSchema</name>
  <files>src/activation/cans-schema.ts</files>
  <action>
Add three new sub-schemas to `src/activation/cans-schema.ts` ABOVE the CANSSchema definition, following the existing pattern of individual exported schemas (ProviderSchema, ScopeSchema, etc.):

**NeuronConfigSchema** (after ClinicalVoiceSchema section):
```typescript
export const NeuronConfigSchema = Type.Object({
  endpoint: Type.String({ description: 'Neuron server URL' }),
  registration_id: Type.Optional(Type.String({ description: 'Registration ID assigned by Neuron' })),
  auto_register: Type.Optional(Type.Boolean({ description: 'Register on Gateway startup' })),
});
export type NeuronConfig = Static<typeof NeuronConfigSchema>;
```

**SkillGatingRuleSchema and SkillGatingSchema:**
```typescript
export const SkillGatingRuleSchema = Type.Object({
  skill_id: Type.String({ description: 'Skill package identifier' }),
  requires_license: Type.Optional(Type.Array(Type.String())),
  requires_specialty: Type.Optional(Type.Array(Type.String())),
  requires_privilege: Type.Optional(Type.Array(Type.String())),
});
export type SkillGatingRule = Static<typeof SkillGatingRuleSchema>;

export const SkillGatingSchema = Type.Object({
  rules: Type.Array(SkillGatingRuleSchema, { description: 'Per-skill credential requirements' }),
});
export type SkillGating = Static<typeof SkillGatingSchema>;
```

**CrossInstallationConsentSchema:**
```typescript
export const CrossInstallationConsentSchema = Type.Object({
  allow_inbound: Type.Boolean({ description: 'Accept patient CareAgent connections' }),
  allow_outbound: Type.Boolean({ description: 'Initiate connections to patient CareAgents' }),
  require_neuron_verification: Type.Optional(Type.Boolean({ description: 'Require Neuron-verified identity' })),
});
export type CrossInstallationConsent = Static<typeof CrossInstallationConsentSchema>;
```

**Update CANSSchema** to add 3 new optional fields at the end:
```typescript
export const CANSSchema = Type.Object({
  version: Type.String({ description: 'CANS.md schema version' }),
  provider: ProviderSchema,
  scope: ScopeSchema,
  autonomy: AutonomySchema,
  hardening: HardeningSchema,
  consent: ConsentSchema,
  clinical_voice: Type.Optional(ClinicalVoiceSchema),
  neuron: Type.Optional(NeuronConfigSchema),
  skills: Type.Optional(SkillGatingSchema),
  cross_installation: Type.Optional(CrossInstallationConsentSchema),
});
```

CRITICAL: All three new fields MUST be `Type.Optional()`. This ensures backward compatibility with existing test fixtures and CANS.md files.

Run `npx vitest run` to confirm all 388 existing tests pass unchanged.
  </action>
  <verify>`npx vitest run` passes all 388 existing tests. `npx tsc --noEmit` exits 0. The valid-cans-data.ts fixture still validates without modification.</verify>
  <done>CANSSchema has 3 new optional top-level fields (neuron, skills, cross_installation) with proper sub-schemas and exported TypeScript types. All existing tests pass without modification.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for new CANS schema fields</name>
  <files>test/unit/activation/cans-schema.test.ts</files>
  <action>
Add new test groups to the existing `test/unit/activation/cans-schema.test.ts` file. Import `Value` from `@sinclair/typebox/value` (already imported in the test file). Use the existing `validCANSData` fixture from `test/fixtures/valid-cans-data.ts` as the base.

**Add these test groups:**

1. **"neuron validation"** describe block:
   - "accepts valid CANS data without neuron field" -- validates `validCANSData` (unchanged), confirms optional works
   - "accepts valid neuron config with all fields" -- spread `validCANSData` + `neuron: { endpoint: 'https://neuron.example.com', registration_id: 'reg-123', auto_register: true }`
   - "accepts neuron config with only required endpoint" -- spread + `neuron: { endpoint: 'https://neuron.example.com' }`
   - "rejects neuron config without endpoint" -- spread + `neuron: {}` should fail validation

2. **"skills validation"** describe block:
   - "accepts valid CANS data without skills field" -- validates `validCANSData` (unchanged)
   - "accepts valid skill gating rules" -- spread + `skills: { rules: [{ skill_id: 'chart-skill', requires_license: ['MD', 'DO'], requires_specialty: ['neurosurgery'] }] }`
   - "accepts empty skill gating rules array" -- spread + `skills: { rules: [] }`
   - "rejects skill gating rule without skill_id" -- spread + `skills: { rules: [{}] }` should fail
   - "accepts skill gating rule with only skill_id" -- spread + `skills: { rules: [{ skill_id: 'chart-skill' }] }`

3. **"cross_installation validation"** describe block:
   - "accepts valid CANS data without cross_installation field" -- validates `validCANSData` (unchanged)
   - "accepts valid cross_installation consent" -- spread + `cross_installation: { allow_inbound: true, allow_outbound: false, require_neuron_verification: true }`
   - "accepts cross_installation without require_neuron_verification" -- spread + `cross_installation: { allow_inbound: true, allow_outbound: true }`
   - "rejects cross_installation missing allow_inbound" -- spread + `cross_installation: { allow_outbound: true }` should fail
   - "rejects cross_installation missing allow_outbound" -- spread + `cross_installation: { allow_inbound: true }` should fail

4. **"combined new fields"** describe block:
   - "accepts CANS data with all three new optional fields" -- spread + all three fields populated

Use the same validation pattern as existing tests: `Value.Check(CANSSchema, data)` returns boolean.

Run `npx vitest run` to confirm all tests pass (388 existing + ~15 new).
  </action>
  <verify>`npx vitest run` passes all tests (388 original + ~15 new schema tests). Each new test exercises the boundary between valid and invalid data for the new fields.</verify>
  <done>Comprehensive tests cover neuron, skills, and cross_installation schema validation including optional field behavior, valid data, invalid data, and combined usage. Total test count increased by ~15.</done>
</task>

</tasks>

<verification>
- `npx vitest run` passes all tests (388 original + ~15 new)
- `npx tsc --noEmit` exits 0
- `grep "Type.Optional(NeuronConfigSchema)" src/activation/cans-schema.ts` returns a match
- `grep "Type.Optional(SkillGatingSchema)" src/activation/cans-schema.ts` returns a match
- `grep "Type.Optional(CrossInstallationConsentSchema)" src/activation/cans-schema.ts` returns a match
- Existing test fixture `test/fixtures/valid-cans-data.ts` validates without any changes
</verification>

<success_criteria>
CANS schema extended with 3 new optional top-level fields. All existing 388 tests pass unchanged. New tests comprehensively validate the new schema fields. TypeBox types exported for downstream use.
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-architectural-alignment/02.1-03-SUMMARY.md`
</output>
